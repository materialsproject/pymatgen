
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pymatgen.io.abinitio.workflows &mdash; pymatgen 2.8.8 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/proBlue.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '2.8.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="pymatgen 2.8.8 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">pymatgen 2.8.8 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pymatgen.io.abinitio.workflows</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Abinit Workflows</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pydispatch</span> <span class="kn">import</span> <span class="n">dispatcher</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="kn">import</span> <span class="n">ArrayWithUnit</span><span class="p">,</span> <span class="n">Ha_to_eV</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.lattice</span> <span class="kn">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.design_patterns</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">AttrDict</span>
<span class="kn">from</span> <span class="nn">pymatgen.serializers.json_coders</span> <span class="kn">import</span> <span class="n">MSONable</span><span class="p">,</span> <span class="n">json_pretty_dump</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.smartio</span> <span class="kn">import</span> <span class="n">read_structure</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.num_utils</span> <span class="kn">import</span> <span class="n">iterator_from_slice</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">monotonic</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.string_utils</span> <span class="kn">import</span> <span class="n">list_strings</span><span class="p">,</span> <span class="n">pprint_table</span><span class="p">,</span> <span class="n">WildCard</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio</span> <span class="kn">import</span> <span class="n">wrappers</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.tasks</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">AbinitTask</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">ScfTask</span><span class="p">,</span> <span class="n">NscfTask</span><span class="p">,</span> <span class="n">HaydockBseTask</span><span class="p">,</span> <span class="n">RelaxTask</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.strategies</span> <span class="kn">import</span> <span class="n">Strategy</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.utils</span> <span class="kn">import</span> <span class="n">File</span><span class="p">,</span> <span class="n">Directory</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.netcdf</span> <span class="kn">import</span> <span class="n">ETSF_Reader</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.abiobjects</span> <span class="kn">import</span> <span class="n">Smearing</span><span class="p">,</span> <span class="n">AbiStructure</span><span class="p">,</span> <span class="n">KSampling</span><span class="p">,</span> <span class="n">Electrons</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.pseudos</span> <span class="kn">import</span> <span class="n">Pseudo</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.strategies</span> <span class="kn">import</span> <span class="n">ScfStrategy</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.eos</span> <span class="kn">import</span> <span class="n">EOS</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.abitimer</span> <span class="kn">import</span> <span class="n">AbinitTimerParser</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Matteo Giantomassi&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2013, The Materials Project&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.1&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s">&quot;Matteo Giantomassi&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;Workflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;IterativeWorkflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;BandStructureWorkflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;RelaxWorkflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;DeltaFactorWorkflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;G0W0_Workflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;BSEMDF_Workflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;PhononWorkflow&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">WorkflowError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for the exceptions raised by Workflow objects.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">BaseWorkflow</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

    <span class="n">Error</span> <span class="o">=</span> <span class="n">WorkflowError</span>

    <span class="c"># interface modeled after subprocess.Popen</span>
    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">processes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of objects that support the subprocess.Popen protocol.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if all child processes have terminated. Set and return</span>
<span class="sd">        returncode attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for child processed to terminate. Set and return returncode attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interact with processes: Send data to stdin. Read data from stdout and</span>
<span class="sd">        stderr, until end-of-file is reached.</span>
<span class="sd">        Wait for process to terminate. The optional input argument should be a</span>
<span class="sd">        string to be sent to the child processed, or None, if no data should be</span>
<span class="sd">        sent to the children.</span>

<span class="sd">        communicate() returns a list of tuples (stdoutdata, stderrdata).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">show_intrawork_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the dependencies within the `Workflow`.&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&quot;Task #&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))]]</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">task1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">*</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">]</span>
            <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">task2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">task1</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">task2</span><span class="p">):</span>
                    <span class="n">line</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;^&quot;</span>

            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">pprint_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">returncodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The children return codes, set by poll() and wait() (and indirectly by communicate()).</span>
<span class="sd">        A None value indicates that the process hasn&#39;t terminated yet.</span>
<span class="sd">        A negative value -N indicates that the child was terminated by signal N (Unix only).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">returncode</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncpus_reserved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs reserved in this moment.</span>
<span class="sd">        A CPUS is reserved if it&#39;s still not running but </span>
<span class="sd">        we have submitted the task to the queue manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tot_ncpus</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">S_SUB</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncpus_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs allocated in this moment.</span>
<span class="sd">        A CPU is allocated if it&#39;s running a task or if we have</span>
<span class="sd">        submitted a task to the queue manager but the job is still pending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tot_ncpus</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">S_SUB</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">S_RUN</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncpus_inuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs used in this moment.</span>
<span class="sd">        A CPU is used if there&#39;s a job that is running on it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tot_ncpus</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">S_RUN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fetch_task_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the first task that is ready to run or </span>
<span class="sd">        None if no task can be submitted at present&quot;</span>

<span class="sd">        Raises:</span>
<span class="sd">            `StopIteration` if all tasks are done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># All the tasks are done so raise an exception </span>
        <span class="c"># that will be handled by the client code.</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">is_completed</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="s">&quot;All tasks completed.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">can_run</span><span class="p">:</span>
                <span class="c">#print(task, str(task.status), [task.deps_status])</span>
                <span class="k">return</span> <span class="n">task</span>

        <span class="c"># No task found, this usually happens when we have dependencies. </span>
        <span class="c"># Beware of possible deadlocks here!</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Possible deadlock in fetch_task_to_run!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method called before submitting the calculations.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect the signals within the workflow.</span>
<span class="sd">        self is responsible for catching the important signals raised from </span>
<span class="sd">        its task and raise new signals when some particular condition occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">dispatcher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_ok</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">S_OK</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">S_OK</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This callback is called when one task reaches status S_OK.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;in on_ok with sender </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sender</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ok</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Workflow has been already finalized&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">on_all_ok</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># Signal to possible observers that the `Workflow` reached S_OK</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Workflow </span><span class="si">%s</span><span class="s"> is finalized and broadcasts signal S_OK&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Workflow </span><span class="si">%s</span><span class="s"> status = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
                <span class="n">dispatcher</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_OK</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">results</span>

        <span class="k">return</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Not all tasks are OK!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called once the `workflow` is completed i.e. when all the tasks </span>
<span class="sd">        have reached status S_OK. Subclasses should provide their own implementation</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary that must contain at least the following entries:</span>
<span class="sd">                returncode:</span>
<span class="sd">                    0 on success. </span>
<span class="sd">                message: </span>
<span class="sd">                    a string that should provide a human-readable description of what has been performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                    <span class="n">message</span><span class="o">=</span><span class="s">&quot;Calling on_all_ok of the base class!&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called once the calculations are completed.</span>

<span class="sd">        The base version returns a dictionary task_name : TaskResults for each task in self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">WorkflowResults</span><span class="p">(</span><span class="n">task_results</span><span class="o">=</span><span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">results</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">})</span>


<div class="viewcode-block" id="Workflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow">[docs]</a><span class="k">class</span> <span class="nc">Workflow</span><span class="p">(</span><span class="n">BaseWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Workflow is a list of (possibly connected) tasks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">WorkflowError</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            workdir:</span>
<span class="sd">                Path to the working directory.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>

<div class="viewcode-block" id="Workflow.set_manager"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.set_manager">[docs]</a>    <span class="k">def</span> <span class="nf">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the `TaskManager` to use to launch the Task.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.flow">[docs]</a>    <span class="k">def</span> <span class="nf">flow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The flow containing this `Workflow`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flow</span>
</div>
<div class="viewcode-block" id="Workflow.set_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.set_flow">[docs]</a>    <span class="k">def</span> <span class="nf">set_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the flow associated to this `Workflow`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_flow&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flow</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flow</span> <span class="o">!=</span> <span class="n">flow</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;self._flow != flow&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.set_workdir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the working directory. Cannot be set more than once.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;workdir&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">!=</span> <span class="n">workdir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;self.workdir != workdir: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>  <span class="n">workdir</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
                                                                       
        <span class="c"># Directories with (input|output|temporary) data.</span>
        <span class="c"># The workflow will use these directories to connect </span>
        <span class="c"># itself to other workflows and/or to produce new data </span>
        <span class="c"># that will be used by its children.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;indata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;outdata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;tmpdata&quot;</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="nb">slice</span><span class="p">]</span>

<div class="viewcode-block" id="Workflow.chunks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.chunks">[docs]</a>    <span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield successive chunks of tasks of lenght chunk_size.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tasks</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">tasks</span>
</div>
    <span class="k">def</span> <span class="nf">opath_from_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path of the output file with extension ext.</span>
<span class="sd">        Use it when the file does not exist yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;in_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>

<div class="viewcode-block" id="Workflow.opath_from_ext"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.opath_from_ext">[docs]</a>    <span class="k">def</span> <span class="nf">opath_from_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path of the output file with extension ext.</span>
<span class="sd">        Use it when the file does not exist yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;out_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.processes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.processes">[docs]</a>    <span class="k">def</span> <span class="nf">processes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">process</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.all_done"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.all_done">[docs]</a>    <span class="k">def</span> <span class="nf">all_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all the `Task` in the `Workflow` are done.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="n">task</span><span class="o">.</span><span class="n">S_DONE</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.isnc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.isnc">[docs]</a>    <span class="k">def</span> <span class="nf">isnc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if norm-conserving calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">isnc</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.ispaw"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.ispaw">[docs]</a>    <span class="k">def</span> <span class="nf">ispaw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if PAW calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">ispaw</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.status_counter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.status_counter">[docs]</a>    <span class="k">def</span> <span class="nf">status_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a `Counter` object that counts the number of task with </span>
<span class="sd">        given status (use the string representation of the status as key).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span> 

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">counter</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">counter</span>
</div>
<div class="viewcode-block" id="Workflow.allocate"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.allocate">[docs]</a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called once we have completed the initialization </span>
<span class="sd">        of the `Workflow`. It sets the manager of each task (if not already done)</span>
<span class="sd">        and defines the working directories of the tasks.</span>

<span class="sd">        Args:</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c">#print(hasattr(task, &quot;manager&quot;))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s">&quot;manager&quot;</span><span class="p">):</span>
                <span class="c"># Set the manager</span>

                <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># Use the one provided in input.</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Use the one of the workflow.</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>

            <span class="n">task_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;task_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s">&quot;workdir&quot;</span><span class="p">):</span>
                <span class="n">task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">task_workdir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">workdir</span> <span class="o">!=</span> <span class="n">task_workdir</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;task.workdir != task_workdir: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">task_workdir</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Workflow.register"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a new `Task` and add it to the internal list, taking into account possible dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj:</span>
<span class="sd">                `Strategy` object or `AbinitInput` instance.</span>
<span class="sd">                if Strategy object, we create a new `AbinitTask` from the input strategy and add it to the list.</span>
<span class="sd">            deps:</span>
<span class="sd">                Dictionary specifying the dependency of this node.</span>
<span class="sd">                None means that this obj has no dependency.</span>
<span class="sd">            manager:</span>
<span class="sd">                The `TaskManager` responsible for the submission of the task. If manager is None, we use </span>
<span class="sd">                the `TaskManager` specified during the creation of the `Workflow`.</span>
<span class="sd">            task_class:</span>
<span class="sd">                Task subclass to instantiate. Default: `AbinitTask` </span>

<span class="sd">        Returns:   </span>
<span class="sd">            `Task` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task_workdir</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;workdir&quot;</span><span class="p">):</span>
            <span class="n">task_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;task_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Task</span><span class="p">):</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Set the class</span>
            <span class="k">if</span> <span class="n">task_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">task_class</span> <span class="o">=</span> <span class="n">AbinitTask</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Strategy</span><span class="p">):</span>
                <span class="c"># Create the new task (note the factory so that we create subclasses easily).</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">task_workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">from_input</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">task_workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="c"># Handle possible dependencies.</span>
        <span class="k">if</span> <span class="n">deps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dependency</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">task</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span>
</div>
<div class="viewcode-block" id="Workflow.path_in_workdir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.path_in_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">path_in_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the absolute path of filename in the working directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.setup"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called before running the calculations.</span>
<span class="sd">        The default implementation is empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="Workflow.build"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the top level directory.&quot;&quot;&quot;</span>
        <span class="c"># Create the directories of the workflow.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>

        <span class="c"># Build dirs and files of each task.</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Connect signals within the workflow.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the status of the workflow i.e. the minimum of the status of the tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_status</span><span class="p">(</span><span class="n">only_min</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c">#def set_status(self, status):</span>
</div>
<div class="viewcode-block" id="Workflow.get_all_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.get_all_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">only_min</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list with the status of the tasks in self.</span>

<span class="sd">        Args:</span>
<span class="sd">            only_min:</span>
<span class="sd">                If True, the minimum of the status is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># The workflow will be created in the future.</span>
            <span class="k">if</span> <span class="n">only_min</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_INIT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">S_INIT</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>

        <span class="n">status_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="c">#print(&quot;status_list&quot;, status_list)</span>

        <span class="k">if</span> <span class="n">only_min</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">status_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">status_list</span>
</div>
<div class="viewcode-block" id="Workflow.check_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.check_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the status of the tasks.&quot;&quot;&quot;</span>
        <span class="c"># Recompute the status of the tasks</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>

        <span class="c"># Take into account possible dependencies.Use a list instead of generators </span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="n">task</span><span class="o">.</span><span class="n">S_SUB</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">status</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">S_OK</span> <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">deps_status</span><span class="p">]):</span> 
                <span class="n">task</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">S_READY</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.rmtree"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.rmtree">[docs]</a>    <span class="k">def</span> <span class="nf">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude_wildcard</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all files and directories in the working directory</span>

<span class="sd">        Args:</span>
<span class="sd">            exclude_wildcard:</span>
<span class="sd">                Optional string with regular expressions separated by `|`.</span>
<span class="sd">                Files matching one of the regular expressions will be preserved.</span>
<span class="sd">                example: exclude_wildard=&quot;*.nc|*.txt&quot; preserves all the files</span>
<span class="sd">                whose extension is in [&quot;nc&quot;, &quot;txt&quot;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude_wildcard</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">WildCard</span><span class="p">(</span><span class="n">exclude_wildcard</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.rm_indatadir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.rm_indatadir">[docs]</a>    <span class="k">def</span> <span class="nf">rm_indatadir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the indata directories.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">rm_indatadir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Workflow.rm_outdatadir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.rm_outdatadir">[docs]</a>    <span class="k">def</span> <span class="nf">rm_outdatadir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the indata directories.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">rm_outatadir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Workflow.rm_tmpdatadir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.rm_tmpdatadir">[docs]</a>    <span class="k">def</span> <span class="nf">rm_tmpdatadir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the tmpdata directories.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">rm_tmpdatadir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Workflow.move"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">isabspath</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively move self.workdir to another location. This is similar to the Unix &quot;mv&quot; command.</span>
<span class="sd">        The destination path must not already exist. If the destination already exists</span>
<span class="sd">        but is not a directory, it may be overwritten depending on os.rename() semantics.</span>

<span class="sd">        Be default, dest is located in the parent directory of self.workdir, use isabspath=True</span>
<span class="sd">        to specify an absolute path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isabspath</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">),</span> <span class="n">dest</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.submit_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.submit_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">submit_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits the task in self and wait.</span>
<span class="sd">        TODO: change name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Workflow.start"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the work. Calls build and _setup first, then submit the tasks.</span>
<span class="sd">        Non-blocking call unless wait is set to True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;wait&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="c"># Build dirs and files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Initial setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Submit tasks (does not block)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit_tasks</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.read_etotal"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.read_etotal">[docs]</a>    <span class="k">def</span> <span class="nf">read_etotal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the total energy from the GSR file produced by the task.</span>

<span class="sd">        Return a numpy array with the total energies in Hartree</span>
<span class="sd">        The array element is set to np.inf if an exception is raised while reading the GSR file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Some task is still in running/submitted state&quot;</span><span class="p">)</span>

        <span class="n">etotal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c"># Open the GSR file and read etotal (Hartree)</span>
            <span class="n">gsr_path</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s">&quot;GSR&quot;</span><span class="p">)</span>
            <span class="n">etot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">if</span> <span class="n">gsr_path</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ETSF_Reader</span><span class="p">(</span><span class="n">gsr_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                    <span class="n">etot</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s">&quot;etotal&quot;</span><span class="p">)</span>
                
            <span class="n">etotal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etot</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">etotal</span>
</div>
<div class="viewcode-block" id="Workflow.parse_timers"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.parse_timers">[docs]</a>    <span class="k">def</span> <span class="nf">parse_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the TIMER section reported in the ABINIT output files.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `AbinitTimerParser` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>
                                                                           
        <span class="n">parser</span> <span class="o">=</span> <span class="n">AbinitTimerParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
                                                                           
        <span class="k">return</span> <span class="n">parser</span>

</div></div>
<div class="viewcode-block" id="IterativeWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.IterativeWorkflow">[docs]</a><span class="k">class</span> <span class="nc">IterativeWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object defines a `Workflow` that produces `Tasks` until a particular </span>
<span class="sd">    condition is satisfied (mainly used for convergence studies or iterative algorithms.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_generator</span><span class="p">,</span> <span class="n">max_niter</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            strategy_generator:</span>
<span class="sd">                Generator object that produces `Strategy` objects.</span>
<span class="sd">            max_niter:</span>
<span class="sd">                Maximum number of iterations. A negative value or zero value</span>
<span class="sd">                is equivalent to having an infinite number of iterations.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IterativeWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_generator</span> <span class="o">=</span> <span class="n">strategy_generator</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_niter</span> <span class="o">=</span> <span class="n">max_niter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="IterativeWorkflow.max_niter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.IterativeWorkflow.max_niter">[docs]</a>    <span class="k">def</span> <span class="nf">max_niter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_niter</span>

    <span class="c">#def set_max_niter(self, max_niter):</span>
    <span class="c">#    self._max_niter = max_niter</span>

    <span class="c">#def set_inputs(self, inputs):</span>
    <span class="c">#    self.strategy_generator = list(inputs)</span>
</div>
<div class="viewcode-block" id="IterativeWorkflow.next_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.IterativeWorkflow.next_task">[docs]</a>    <span class="k">def</span> <span class="nf">next_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate and register a new `Task`.</span>

<span class="sd">        Returns: </span>
<span class="sd">            New `Task` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_strategy</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy_generator</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">next_strategy</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">niter</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="IterativeWorkflow.submit_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.IterativeWorkflow.submit_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">submit_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the tasks till self.exit_iteration says to exit </span>
<span class="sd">        or the number of iterations exceeds self.max_niter</span>

<span class="sd">        Returns: </span>
<span class="sd">            dictionary with the final results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_niter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;niter </span><span class="si">%d</span><span class="s"> &gt; max_niter </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">niter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_niter</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_task</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c"># Start the task and block till completion.</span>
            <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_iteration</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;exit&quot;</span><span class="p">]:</span>
                <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="IterativeWorkflow.exit_iteration"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.IterativeWorkflow.exit_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">exit_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary with the results produced at the given iteration.</span>
<span class="sd">        The dictionary must contains an entry &quot;converged&quot; that evaluates to</span>
<span class="sd">        True if the iteration should be stopped.</span>
<span class="sd">        &quot;&quot;&quot;</span>

</div></div>
<span class="k">def</span> <span class="nf">check_conv</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">min_numpts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;abs&quot;</span><span class="p">,</span> <span class="n">vinf</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of values and a tolerance tol, returns the leftmost index for which</span>

<span class="sd">        abs(value[i] - vinf) &lt; tol if mode == &quot;abs&quot;</span>

<span class="sd">    or</span>

<span class="sd">        abs(value[i] - vinf) / vinf &lt; tol if mode == &quot;rel&quot;</span>

<span class="sd">    returns -1 if convergence is not achieved. By default, vinf = values[-1]</span>

<span class="sd">    Args:</span>
<span class="sd">        tol:</span>
<span class="sd">            Tolerance</span>
<span class="sd">        min_numpts:</span>
<span class="sd">            Minimum number of points that must be converged.</span>
<span class="sd">        mode:</span>
<span class="sd">            &quot;abs&quot; for absolute convergence, &quot;rel&quot; for relative convergence.</span>
<span class="sd">        vinf:</span>
<span class="sd">            Used to specify an alternative value instead of values[-1].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vinf</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">vinf</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">vinf</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;abs&quot;</span><span class="p">:</span>
        <span class="n">vdiff</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">vinf</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;rel&quot;</span><span class="p">:</span>
        <span class="n">vdiff</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">vinf</span><span class="p">)</span> <span class="o">/</span> <span class="n">vinf</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Wrong mode </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>

    <span class="n">numpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vdiff</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">numpts</span> <span class="o">&gt;</span> <span class="n">min_numpts</span><span class="p">)</span> <span class="ow">and</span> <span class="n">vdiff</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numpts</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">vdiff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">numpts</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_numpts</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">compute_hints</span><span class="p">(</span><span class="n">ecut_list</span><span class="p">,</span> <span class="n">etotal</span><span class="p">,</span> <span class="n">atols_mev</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">,</span> <span class="n">min_numpts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="n">de_low</span><span class="p">,</span> <span class="n">de_normal</span><span class="p">,</span> <span class="n">de_high</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">Ha_to_eV</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atols_mev</span><span class="p">]</span>

    <span class="n">num_ene</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">etotal</span><span class="p">)</span>
    <span class="n">etotal_inf</span> <span class="o">=</span> <span class="n">etotal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ihigh</span>   <span class="o">=</span> <span class="n">check_conv</span><span class="p">(</span><span class="n">etotal</span><span class="p">,</span> <span class="n">de_high</span><span class="p">,</span> <span class="n">min_numpts</span><span class="o">=</span><span class="n">min_numpts</span><span class="p">)</span>
    <span class="n">inormal</span> <span class="o">=</span> <span class="n">check_conv</span><span class="p">(</span><span class="n">etotal</span><span class="p">,</span> <span class="n">de_normal</span><span class="p">)</span>
    <span class="n">ilow</span>    <span class="o">=</span> <span class="n">check_conv</span><span class="p">(</span><span class="n">etotal</span><span class="p">,</span> <span class="n">de_low</span><span class="p">)</span>

    <span class="n">accidx</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;H&quot;</span><span class="p">:</span> <span class="n">ihigh</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">:</span> <span class="n">inormal</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">:</span> <span class="n">ilow</span><span class="p">}</span>

    <span class="n">table</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">app</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">append</span>

    <span class="n">app</span><span class="p">([</span><span class="s">&quot;iter&quot;</span><span class="p">,</span> <span class="s">&quot;ecut&quot;</span><span class="p">,</span> <span class="s">&quot;etotal&quot;</span><span class="p">,</span> <span class="s">&quot;et-e_inf [meV]&quot;</span><span class="p">,</span> <span class="s">&quot;accuracy&quot;</span><span class="p">,])</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">et</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ecut_list</span><span class="p">,</span> <span class="n">etotal</span><span class="p">)):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> </span><span class="si">%.1f</span><span class="s"> </span><span class="si">%.7f</span><span class="s"> </span><span class="si">%.3f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="p">(</span><span class="n">et</span><span class="o">-</span><span class="n">etotal_inf</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ha_to_eV</span> <span class="o">*</span> <span class="mf">1.e+3</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">accidx</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)]</span>
        <span class="n">app</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;pseudo: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pseudo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">pprint_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

    <span class="n">ecut_high</span><span class="p">,</span> <span class="n">ecut_normal</span><span class="p">,</span> <span class="n">ecut_low</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="bp">None</span><span class="p">,)</span>
    <span class="nb">exit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ihigh</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">exit</span><span class="p">:</span>
        <span class="n">ecut_low</span>    <span class="o">=</span> <span class="n">ecut_list</span><span class="p">[</span><span class="n">ilow</span><span class="p">]</span>
        <span class="n">ecut_normal</span> <span class="o">=</span> <span class="n">ecut_list</span><span class="p">[</span><span class="n">inormal</span><span class="p">]</span>
        <span class="n">ecut_high</span>   <span class="o">=</span> <span class="n">ecut_list</span><span class="p">[</span><span class="n">ihigh</span><span class="p">]</span>

    <span class="n">aug_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,]</span>
    <span class="n">aug_ratio_low</span><span class="p">,</span> <span class="n">aug_ratio_normal</span><span class="p">,</span> <span class="n">aug_ratio_high</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;exit&quot;</span>       <span class="p">:</span> <span class="n">ihigh</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s">&quot;etotal&quot;</span>     <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">etotal</span><span class="p">),</span>
        <span class="s">&quot;ecut_list&quot;</span>  <span class="p">:</span> <span class="n">ecut_list</span><span class="p">,</span>
        <span class="s">&quot;aug_ratios&quot;</span> <span class="p">:</span> <span class="n">aug_ratios</span><span class="p">,</span>
        <span class="s">&quot;low&quot;</span>        <span class="p">:</span> <span class="p">{</span><span class="s">&quot;ecut&quot;</span><span class="p">:</span> <span class="n">ecut_low</span><span class="p">,</span> <span class="s">&quot;aug_ratio&quot;</span><span class="p">:</span> <span class="n">aug_ratio_low</span><span class="p">},</span>
        <span class="s">&quot;normal&quot;</span>     <span class="p">:</span> <span class="p">{</span><span class="s">&quot;ecut&quot;</span><span class="p">:</span> <span class="n">ecut_normal</span><span class="p">,</span> <span class="s">&quot;aug_ratio&quot;</span><span class="p">:</span> <span class="n">aug_ratio_normal</span><span class="p">},</span>
        <span class="s">&quot;high&quot;</span>       <span class="p">:</span> <span class="p">{</span><span class="s">&quot;ecut&quot;</span><span class="p">:</span> <span class="n">ecut_high</span><span class="p">,</span> <span class="s">&quot;aug_ratio&quot;</span><span class="p">:</span> <span class="n">aug_ratio_high</span><span class="p">},</span>
        <span class="s">&quot;pseudo_name&quot;</span><span class="p">:</span> <span class="n">pseudo</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s">&quot;pseudo_path&quot;</span><span class="p">:</span> <span class="n">pseudo</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
        <span class="s">&quot;atols_mev&quot;</span>  <span class="p">:</span> <span class="n">atols_mev</span><span class="p">,</span>
        <span class="s">&quot;dojo_level&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">plot_etotal</span><span class="p">(</span><span class="n">ecut_list</span><span class="p">,</span> <span class="n">etotals</span><span class="p">,</span> <span class="n">aug_ratios</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses Matplotlib to plot the energy curve as function of ecut</span>

<span class="sd">    Args:</span>
<span class="sd">        ecut_list:</span>
<span class="sd">            List of cutoff energies</span>
<span class="sd">        etotals:</span>
<span class="sd">            Total energies in Hartree, see aug_ratios</span>
<span class="sd">        aug_ratios:</span>
<span class="sd">            List augmentation rations. [1,] for norm-conserving, [4, ...] for PAW</span>
<span class="sd">            The number of elements in aug_ration must equal the number of (sub)lists</span>
<span class="sd">            in etotals. Example:</span>

<span class="sd">                - NC: etotals = [3.4, 4,5 ...], aug_ratios = [1,]</span>
<span class="sd">                - PAW: etotals = [[3.4, ...], [3.6, ...]], aug_ratios = [4,6]</span>

<span class="sd">        =========     ==============================================================</span>
<span class="sd">        kwargs        description</span>
<span class="sd">        =========     ==============================================================</span>
<span class="sd">        show          True to show the figure</span>
<span class="sd">        savefig       &#39;abc.png&#39; or &#39;abc.eps&#39;* to save the figure to a file.</span>
<span class="sd">        =========     ==============================================================</span>

<span class="sd">    Returns:</span>
<span class="sd">        `matplotlib` figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">show</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;show&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">savefig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;savefig&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ecut_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_ratios</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_ratios</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">etotals</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The number of sublists in etotal must equal the number of aug_ratios&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_ratios</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">etotals</span> <span class="o">=</span> <span class="p">[</span><span class="n">etotals</span><span class="p">,]</span>

    <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">emax</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">aratio</span><span class="p">,</span> <span class="n">etot</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aug_ratios</span><span class="p">,</span> <span class="n">etotals</span><span class="p">):</span>
        <span class="n">emev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">etot</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ha_to_eV</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">emev_inf</span> <span class="o">=</span> <span class="n">npts</span> <span class="o">*</span> <span class="p">[</span><span class="n">emev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">emev</span> <span class="o">-</span> <span class="n">emev_inf</span>

        <span class="n">emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">emax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>

        <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ecut_list</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="s">&quot;--&gt;&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;aug_ratio = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">aratio</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="s">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># Set xticks and labels.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&quot;Ecut [Ha]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&quot;$\Delta$ Etotal [meV]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ecut_list</span><span class="p">)</span>

    <span class="c">#ax.yaxis.set_view_interval(-10, emax + 0.01 * abs(emax))</span>
    <span class="c">#ax.xaxis.set_view_interval(-10, 20)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_view_interval</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;$\Delta$ Etotal Vs Ecut&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">savefig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefig</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>


<span class="k">class</span> <span class="nc">PseudoConvergence</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">,</span> <span class="n">ecut_list</span><span class="p">,</span> <span class="n">atols_mev</span><span class="p">,</span>
                 <span class="n">toldfe</span><span class="o">=</span><span class="mf">1.e-8</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s">&quot;polarized&quot;</span><span class="p">,</span> 
                 <span class="n">acell</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">smearing</span><span class="o">=</span><span class="s">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">PseudoConvergence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>

        <span class="c"># Temporary object used to build the strategy.</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">PseudoIterativeConvergence</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">,</span> <span class="n">ecut_list</span><span class="p">,</span> <span class="n">atols_mev</span><span class="p">,</span>
                                               <span class="n">toldfe</span>    <span class="o">=</span> <span class="n">toldfe</span><span class="p">,</span>
                                               <span class="n">spin_mode</span> <span class="o">=</span> <span class="n">spin_mode</span><span class="p">,</span>
                                               <span class="n">acell</span>     <span class="o">=</span> <span class="n">acell</span><span class="p">,</span>
                                               <span class="n">smearing</span>  <span class="o">=</span> <span class="n">smearing</span><span class="p">,</span>
                                               <span class="n">max_niter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ecut_list</span><span class="p">),</span>
                                              <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atols_mev</span> <span class="o">=</span> <span class="n">atols_mev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span> <span class="o">=</span> <span class="n">Pseudo</span><span class="o">.</span><span class="n">aspseudo</span><span class="p">(</span><span class="n">pseudo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ecut_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="n">ecut_list</span><span class="p">:</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">strategy_with_ecut</span><span class="p">(</span><span class="n">ecut</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecut_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ecut</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Get the results of the tasks.</span>
        <span class="n">wf_results</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PseudoConvergence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>

        <span class="n">etotal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_etotal</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">compute_hints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecut_list</span><span class="p">,</span> <span class="n">etotal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atols_mev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span><span class="p">)</span>

        <span class="n">plot_etotal</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;ecut_list&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;etotal&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;aug_ratios&quot;</span><span class="p">],</span>
            <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_in_workdir</span><span class="p">(</span><span class="s">&quot;etotal.pdf&quot;</span><span class="p">))</span>

        <span class="n">wf_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">monotonic</span><span class="p">(</span><span class="n">etotal</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-5</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;E(ecut) is not decreasing&quot;</span><span class="p">)</span>
            <span class="n">wf_results</span><span class="o">.</span><span class="n">push_exceptions</span><span class="p">(</span><span class="s">&quot;E(ecut) is not decreasing:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">etotal</span><span class="p">))</span>

        <span class="c">#if kwargs.get(&quot;json_dump&quot;, True):</span>
        <span class="c">#    wf_results.json_dump(self.path_in_workdir(&quot;results.json&quot;))</span>

        <span class="k">return</span> <span class="n">wf_results</span>


<span class="k">class</span> <span class="nc">PseudoIterativeConvergence</span><span class="p">(</span><span class="n">IterativeWorkflow</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">,</span> <span class="n">ecut_list_or_slice</span><span class="p">,</span> <span class="n">atols_mev</span><span class="p">,</span>
                 <span class="n">toldfe</span><span class="o">=</span><span class="mf">1.e-8</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="s">&quot;polarized&quot;</span><span class="p">,</span> 
                 <span class="n">acell</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">smearing</span><span class="o">=</span><span class="s">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">max_niter</span><span class="o">=</span><span class="mi">50</span><span class="p">,):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory.</span>
<span class="sd">            pseudo:</span>
<span class="sd">                string or Pseudo instance</span>
<span class="sd">            ecut_list_or_slice:</span>
<span class="sd">                List of cutoff energies or slice object (mainly used for infinite iterations).</span>
<span class="sd">            atols_mev:</span>
<span class="sd">                List of absolute tolerances in meV (3 entries corresponding to accuracy [&quot;low&quot;, &quot;normal&quot;, &quot;high&quot;]</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">            spin_mode:</span>
<span class="sd">                Defined how the electronic spin will be treated.</span>
<span class="sd">            acell:</span>
<span class="sd">                Lengths of the periodic box in Bohr.</span>
<span class="sd">            smearing:</span>
<span class="sd">                Smearing instance or string in the form &quot;mode:tsmear&quot;. Default: FemiDirac with T=0.1 eV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span> <span class="o">=</span> <span class="n">Pseudo</span><span class="o">.</span><span class="n">aspseudo</span><span class="p">(</span><span class="n">pseudo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atols_mev</span> <span class="o">=</span> <span class="n">atols_mev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toldfe</span> <span class="o">=</span> <span class="n">toldfe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin_mode</span> <span class="o">=</span> <span class="n">spin_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smearing</span> <span class="o">=</span> <span class="n">Smearing</span><span class="o">.</span><span class="n">assmearing</span><span class="p">(</span><span class="n">smearing</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acell</span> <span class="o">=</span> <span class="n">acell</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ecut_list_or_slice</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecut_iterator</span> <span class="o">=</span> <span class="n">iterator_from_slice</span><span class="p">(</span><span class="n">ecut_list_or_slice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecut_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">ecut_list_or_slice</span><span class="p">)</span>

        <span class="c"># Construct a generator that returns strategy objects.</span>
        <span class="k">def</span> <span class="nf">strategy_generator</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecut_iterator</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy_with_ecut</span><span class="p">(</span><span class="n">ecut</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">PseudoIterativeConvergence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">strategy_generator</span><span class="p">(),</span> 
              <span class="n">max_niter</span><span class="o">=</span><span class="n">max_niter</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isnc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;PAW convergence tests are not supported yet&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">strategy_with_ecut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ecut</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Strategy instance with given cutoff energy ecut.&quot;&quot;&quot;</span>

        <span class="c"># Define the system: one atom in a box of lenghts acell.</span>
        <span class="n">boxed_atom</span> <span class="o">=</span> <span class="n">AbiStructure</span><span class="o">.</span><span class="n">boxed_atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span><span class="p">,</span> <span class="n">acell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acell</span><span class="p">)</span>

        <span class="c"># Gamma-only sampling.</span>
        <span class="n">gamma_only</span> <span class="o">=</span> <span class="n">KSampling</span><span class="o">.</span><span class="n">gamma_only</span><span class="p">()</span>

        <span class="c"># Setup electrons.</span>
        <span class="n">electrons</span> <span class="o">=</span> <span class="n">Electrons</span><span class="p">(</span><span class="n">spin_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">)</span>

        <span class="c"># Don&#39;t write WFK files.</span>
        <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;ecut&quot;</span> <span class="p">:</span> <span class="n">ecut</span><span class="p">,</span>
            <span class="s">&quot;prtwf&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">&quot;toldfe&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">toldfe</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">strategy</span> <span class="o">=</span> <span class="n">ScfStrategy</span><span class="p">(</span><span class="n">boxed_atom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span><span class="p">,</span> <span class="n">gamma_only</span><span class="p">,</span>
                               <span class="n">spin_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smearing</span><span class="p">,</span>
                               <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                               <span class="n">use_symmetries</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_abivars</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">strategy</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ecut_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The list of cutoff energies computed so far&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">ecut</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">check_etotal_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">compute_hints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecut_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_etotal</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">atols_mev</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exit_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_etotal_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the results of the tasks.&quot;&quot;&quot;</span>
        <span class="n">wf_results</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PseudoIterativeConvergence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_etotal_convergence</span><span class="p">()</span>

        <span class="n">ecut_list</span><span class="p">,</span> <span class="n">etotal</span><span class="p">,</span> <span class="n">aug_ratios</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;ecut_list&quot;</span><span class="p">],</span>  <span class="n">data</span><span class="p">[</span><span class="s">&quot;etotal&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;aug_ratios&quot;</span><span class="p">]</span>

        <span class="n">plot_etotal</span><span class="p">(</span><span class="n">ecut_list</span><span class="p">,</span> <span class="n">etotal</span><span class="p">,</span> <span class="n">aug_ratios</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path_in_workdir</span><span class="p">(</span><span class="s">&quot;etotal.pdf&quot;</span><span class="p">))</span>

        <span class="n">wf_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">monotonic</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;etotal&quot;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.0e-5</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;E(ecut) is not decreasing&quot;</span><span class="p">)</span>
            <span class="n">wf_results</span><span class="o">.</span><span class="n">push_exceptions</span><span class="p">(</span><span class="s">&quot;E(ecut) is not decreasing</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">etotal</span><span class="p">))</span>

        <span class="c">#if kwargs.get(&quot;json_dump&quot;, True):</span>
        <span class="c">#    wf_results.json_dump(self.path_in_workdir(&quot;results.json&quot;))</span>

        <span class="k">return</span> <span class="n">wf_results</span>


<div class="viewcode-block" id="BandStructureWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.BandStructureWorkflow">[docs]</a><span class="k">class</span> <span class="nc">BandStructureWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow for band structure calculations.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_input:</span>
<span class="sd">                Input for the SCF run or `SCFStrategy` object.</span>
<span class="sd">            nscf_input:</span>
<span class="sd">                Input for the NSCF run or `NSCFStrategy` object defining the band structure calculation.</span>
<span class="sd">            dos_inputs:</span>
<span class="sd">                Input(s) for the DOS. DOS is computed only if dos_inputs is not None.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BandStructureWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c"># Register the GS-SCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>

        <span class="c"># Register the NSCF run and its dependency.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">NscfTask</span><span class="p">)</span>

        <span class="c"># Add DOS computation if requested.</span>
        <span class="k">if</span> <span class="n">dos_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dos_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">dos_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dos_inputs</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">dos_input</span> <span class="ow">in</span> <span class="n">dos_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">dos_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">NscfTask</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="RelaxWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.RelaxWorkflow">[docs]</a><span class="k">class</span> <span class="nc">RelaxWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Workflow for structural relaxations. The first task relaxes the atomic position</span>
<span class="sd">    while keeping the unit cell parameters fixed. The second task uses the final </span>
<span class="sd">    structure to perform a structural relaxation in which both the atomic positions</span>
<span class="sd">    and the lattice parameters are optimized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ion_input</span><span class="p">,</span> <span class="n">ioncell_input</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            ion_input:</span>
<span class="sd">                Input for the relaxation of the ions (cell is fixed)</span>
<span class="sd">            ioncell_input:</span>
<span class="sd">                Input for the relaxation of the ions and the unit cell.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RelaxWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ion_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ion_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">RelaxTask</span><span class="p">)</span>

        <span class="c"># Use WFK for the time being since I don&#39;t know why Abinit produces all these _TIM?_DEN files.</span>
        <span class="c">#self.ioncell_task = self.register(ioncell_input, deps={self.ion_task: &quot;DEN&quot;}, task_class=RelaxTask)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ioncell_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ion_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">RelaxTask</span><span class="p">)</span>

        <span class="c"># Lock ioncell_task as ion_task should communicate to ioncell_task that </span>
        <span class="c"># the calculation is OK and pass the final structure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_task</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S_LOCKED</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="RelaxWorkflow.on_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.RelaxWorkflow.on_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This callback is called when one task reaches status S_OK.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;in on_ok with sender </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sender</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sender</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ion_task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span><span class="p">:</span>
            <span class="c"># Get the relaxed structure.</span>
            <span class="n">ion_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ion_task</span><span class="o">.</span><span class="n">read_final_structure</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;ion_structure&quot;</span><span class="p">,</span> <span class="n">ion_structure</span><span class="p">)</span>

            <span class="c"># Transfer it to the ioncell task (do it only once).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_task</span><span class="o">.</span><span class="n">change_structure</span><span class="p">(</span><span class="n">ion_structure</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># Finally unlock ioncell_task so that we can submit it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_task</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S_READY</span><span class="p">)</span>

        <span class="n">base_results</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelaxWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_ok</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base_results</span>

</div></div>
<div class="viewcode-block" id="DeltaFactorWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.DeltaFactorWorkflow">[docs]</a><span class="k">class</span> <span class="nc">DeltaFactorWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure_or_cif</span><span class="p">,</span> <span class="n">pseudo</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span>
                 <span class="n">spin_mode</span><span class="o">=</span><span class="s">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">toldfe</span><span class="o">=</span><span class="mf">1.e-8</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span>
                 <span class="n">accuracy</span><span class="o">=</span><span class="s">&quot;normal&quot;</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ecutsm</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> 
                 <span class="c"># FIXME Hack in chksymbreak</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a `Workflow` for the computation of the deltafactor.</span>

<span class="sd">        Args:   </span>
<span class="sd">            structure_or_cif:</span>
<span class="sd">                Structure objec or string with the path of the CIF file.</span>
<span class="sd">            pseudo:</span>
<span class="sd">                String with the name of the pseudopotential file or `Pseudo` object.` object.` object.` </span>
<span class="sd">            kppa:</span>
<span class="sd">                Number of k-points per atom.</span>
<span class="sd">            spin_mode:</span>
<span class="sd">                Spin polarization mode.</span>
<span class="sd">            toldfe:</span>
<span class="sd">                Tolerance on the energy (Ha)</span>
<span class="sd">            smearing:</span>
<span class="sd">                Smearing technique.</span>
<span class="sd">            workdir:</span>
<span class="sd">                String specifing the working directory.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` responsible for the submission of the tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DeltaFactorWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure_or_cif</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">structure_or_cif</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Assume CIF file</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">read_structure</span><span class="p">(</span><span class="n">structure_or_cif</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span> <span class="o">=</span> <span class="n">Pseudo</span><span class="o">.</span><span class="n">aspseudo</span><span class="p">(</span><span class="n">pseudo</span><span class="p">)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">AbiStructure</span><span class="o">.</span><span class="n">asabistructure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="n">smearing</span> <span class="o">=</span> <span class="n">Smearing</span><span class="o">.</span><span class="n">assmearing</span><span class="p">(</span><span class="n">smearing</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_input_structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="n">v0</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">volume</span>

        <span class="c"># From 94% to 106% of the equilibrium volume.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">94</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span>

        <span class="k">for</span> <span class="n">vol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">:</span>
            <span class="n">new_lattice</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>

            <span class="n">new_structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="n">new_lattice</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">species</span><span class="p">,</span> <span class="n">structure</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
            <span class="n">new_structure</span> <span class="o">=</span> <span class="n">AbiStructure</span><span class="o">.</span><span class="n">asabistructure</span><span class="p">(</span><span class="n">new_structure</span><span class="p">)</span>

            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">ecutsm</span><span class="o">=</span><span class="n">ecutsm</span><span class="p">,</span>
                <span class="n">toldfe</span><span class="o">=</span><span class="n">toldfe</span><span class="p">,</span>
                <span class="n">prtwf</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">paral_kgb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">ecut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">extra_abivars</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&quot;ecut&quot;</span><span class="p">:</span> <span class="n">ecut</span><span class="p">})</span>

            <span class="n">ksampling</span> <span class="o">=</span> <span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">new_structure</span><span class="p">,</span> <span class="n">kppa</span><span class="p">,</span>
                                                    <span class="n">chksymbreak</span><span class="o">=</span><span class="n">chksymbreak</span><span class="p">)</span>

            <span class="n">scf_input</span> <span class="o">=</span> <span class="n">ScfStrategy</span><span class="p">(</span><span class="n">new_structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span><span class="p">,</span> <span class="n">ksampling</span><span class="p">,</span>
                                    <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span>
                                    <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_abivars</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>

<div class="viewcode-block" id="DeltaFactorWorkflow.get_results"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.DeltaFactorWorkflow.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_structure</span><span class="o">.</span><span class="n">num_sites</span>

        <span class="n">etotal</span> <span class="o">=</span> <span class="n">ArrayWithUnit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_etotal</span><span class="p">(),</span> <span class="s">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s">&quot;eV&quot;</span><span class="p">)</span>

        <span class="n">wf_results</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DeltaFactorWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>

        <span class="n">wf_results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&quot;etotal&quot;</span>    <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">etotal</span><span class="p">),</span>
            <span class="s">&quot;volumes&quot;</span>   <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">),</span>
            <span class="s">&quot;natom&quot;</span>     <span class="p">:</span> <span class="n">num_sites</span><span class="p">,</span>
            <span class="s">&quot;dojo_level&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c">#eos_fit = EOS.Murnaghan().fit(self.volumes/num_sites, etotal/num_sites)</span>
            <span class="c">#print(&quot;murn&quot;,eos_fit)</span>
            <span class="c">#eos_fit.plot(show=False, savefig=self.path_in_workdir(&quot;murn_eos.pdf&quot;))</span>

            <span class="c"># Use same fit as the one employed for the deltafactor.</span>
            <span class="n">eos_fit</span> <span class="o">=</span> <span class="n">EOS</span><span class="o">.</span><span class="n">DeltaFactor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="o">/</span><span class="n">num_sites</span><span class="p">,</span> <span class="n">etotal</span><span class="o">/</span><span class="n">num_sites</span><span class="p">)</span>

            <span class="n">eos_fit</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;eos.pdf&quot;</span><span class="p">))</span>

            <span class="c"># FIXME: This object should be moved to pseudo_dojo.</span>
            <span class="c"># Get reference results (Wien2K).</span>
            <span class="kn">from</span> <span class="nn">pseudo_dojo.refdata.deltafactor</span> <span class="kn">import</span> <span class="n">df_database</span><span class="p">,</span> <span class="n">df_compute</span>
            <span class="n">wien2k</span> <span class="o">=</span> <span class="n">df_database</span><span class="p">()</span><span class="o">.</span><span class="n">get_entry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pseudo</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
                                                                                                 
            <span class="c"># Compute deltafactor estimator.</span>
            <span class="n">dfact</span> <span class="o">=</span> <span class="n">df_compute</span><span class="p">(</span><span class="n">wien2k</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span> <span class="n">wien2k</span><span class="o">.</span><span class="n">b0_GPa</span><span class="p">,</span> <span class="n">wien2k</span><span class="o">.</span><span class="n">b1</span><span class="p">,</span> <span class="n">eos_fit</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span> <span class="n">eos_fit</span><span class="o">.</span><span class="n">b0_GPa</span><span class="p">,</span> <span class="n">eos_fit</span><span class="o">.</span><span class="n">b1</span><span class="p">,</span> <span class="n">b0_GPa</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&quot;delta&quot;</span><span class="p">,</span><span class="n">eos_fit</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Deltafactor = </span><span class="si">%.3f</span><span class="s"> meV&quot;</span> <span class="o">%</span> <span class="n">dfact</span><span class="p">)</span>

            <span class="n">wf_results</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s">&quot;v0&quot;</span><span class="p">:</span> <span class="n">eos_fit</span><span class="o">.</span><span class="n">v0</span><span class="p">,</span>
                <span class="s">&quot;b0&quot;</span><span class="p">:</span> <span class="n">eos_fit</span><span class="o">.</span><span class="n">b0</span><span class="p">,</span>
                <span class="s">&quot;b0_GPa&quot;</span><span class="p">:</span> <span class="n">eos_fit</span><span class="o">.</span><span class="n">b0_GPa</span><span class="p">,</span>
                <span class="s">&quot;b1&quot;</span><span class="p">:</span> <span class="n">eos_fit</span><span class="o">.</span><span class="n">b1</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="k">except</span> <span class="n">EOS</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">wf_results</span><span class="o">.</span><span class="n">push_exceptions</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

        <span class="c">#if kwargs.get(&quot;json_dump&quot;, True):</span>
        <span class="c">#    wf_results.json_dump(self.path_in_workdir(&quot;results.json&quot;))</span>

        <span class="c"># Write data for the computation of the delta factor</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;deltadata.txt&quot;</span><span class="p">),</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Deltafactor = </span><span class="si">%s</span><span class="s"> meV</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dfact</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Volume/natom [Ang^3] Etotal/natom [eV]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">,</span> <span class="n">etotal</span><span class="p">):</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">/</span><span class="n">num_sites</span><span class="p">,</span> <span class="n">e</span><span class="o">/</span><span class="n">num_sites</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">wf_results</span>
</div>
<div class="viewcode-block" id="DeltaFactorWorkflow.on_all_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.DeltaFactorWorkflow.on_all_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>

    <span class="c">#def make_report(self, results, **kwargs):</span>
    <span class="c">#    d = dict(v0=v0,</span>
    <span class="c">#             b0_GPa=b0_GPa,</span>
    <span class="c">#             b1=b1,</span>
    <span class="c">#             dfact=dfact</span>
    <span class="c">#            )</span>
    <span class="c">#    if results.exceptions:</span>
    <span class="c">#        d[&quot;_exceptions&quot;] = str(results.exceptions)</span>
    <span class="c">#                                                                                         </span>
    <span class="c">#    d = {self.accuracy: d}</span>

</div></div>
<div class="viewcode-block" id="G0W0_Workflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.G0W0_Workflow">[docs]</a><span class="k">class</span> <span class="nc">G0W0_Workflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">,</span>
                 <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workflow for G0W0 calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            scf_input:</span>
<span class="sd">                Input for the SCF run or `SCFStrategy` object.</span>
<span class="sd">            nscf_input:</span>
<span class="sd">                Input for the NSCF run or `NSCFStrategy` object.</span>
<span class="sd">            scr_input:</span>
<span class="sd">                Input for the screening run or `ScrStrategy` object </span>
<span class="sd">            sigma_inputs:</span>
<span class="sd">                List of Strategies for the self-energy run.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory of the calculation.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">G0W0_Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c"># Register the GS-SCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>

        <span class="c"># Construct the input for the NSCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">NscfTask</span><span class="p">)</span>

        <span class="c"># Register the SCREENING run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scr_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">})</span>

        <span class="c"># Register the SIGMA runs.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> 
            <span class="n">sigma_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigma_inputs</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sigma_input</span> <span class="ow">in</span> <span class="n">sigma_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sigma_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scr_task</span><span class="p">:</span> <span class="s">&quot;SCR&quot;</span><span class="p">}))</span>


<span class="c">#class SCGW_Workflow(Workflow):</span>
<span class="c">#</span>
<span class="c">#    def __init__(self, scr_input, sigma_input, workdir=None, manager=None):</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        Workflow for G0W0 calculations.</span>
<span class="c">#</span>
<span class="c">#        Args:</span>
<span class="c">#            scr_input:</span>
<span class="c">#                Input for the screening run or `ScrStrategy` object </span>
<span class="c">#            sigma_input:</span>
<span class="c">#                Strategy for the self-energy run.</span>
<span class="c">#            workdir:</span>
<span class="c">#                Working directory of the calculation.</span>
<span class="c">#            manager:</span>
<span class="c">#                `TaskManager` object.</span>
<span class="c">#        &quot;&quot;&quot;</span>
<span class="c">#        super(SCGW_Workflow, self).__init__(workdir=workdir, manager=manager)</span>
<span class="c">#</span>
<span class="c">#        # Register the SCREENING run.</span>
<span class="c">#        self.scr_task = self.register(scr_input, deps={nscf_task: &quot;WFK&quot;})</span>
<span class="c">#</span>
<span class="c">#        # Register the SIGMA run.</span>
<span class="c">#        self.sigma_task = self.register(sigma_input, deps={self.nscf_task: &quot;WFK&quot;, self.scr_task: &quot;SCR&quot;})</span>
<span class="c">#</span>
<span class="c">#    def not_converged(self):</span>
<span class="c">#       return self.sigma_task.not_converged()</span>
<span class="c">#</span>
<span class="c">#    def restart(self):</span>
<span class="c">#        ext = &quot;QPS&quot;</span>
<span class="c">#        qps_file = self.sigma_task.outdir.has_abiext(ext)</span>
<span class="c">#        irdvars = irdvars_for_ext(ext)</span>
<span class="c">#</span>
<span class="c">#        if not qps_file:</span>
<span class="c">#            raise TaskRestartError(&quot;Cannot find the QPS file to restart from.&quot;)</span>
<span class="c">#</span>
<span class="c">#        # Move the QPS file produced by the SIGMA task to </span>
<span class="c">#        # the indir of the SCR task and the indir of the SIGMA task.</span>
<span class="c">#        scr_infile = self.scr_task.indir.path_in(os.path.basename(qps_file)</span>
<span class="c">#        sigma_infile = self.sigma_task.indir.path_in(os.path.basename(qps_file)</span>
<span class="c">#        shutil.copy(qps_file, scr_infile)</span>
<span class="c">#        shutil.move(qps_file, sigma_infile)</span>
<span class="c">#</span>
<span class="c">#        # Add the appropriate variable for reading the QPS file.</span>
<span class="c">#        self.scr_task.strategy.add_extra_abivars(irdvars)</span>
<span class="c">#        self.sigma_task.strategy.add_extra_abivars(irdvars)</span>
<span class="c">#</span>
<span class="c">#        # Now we can resubmit the job.</span>
<span class="c">#        #for task in self.</span>
<span class="c">#        #    task.reset()</span>
<span class="c">#        self._restart()</span>

</div>
<div class="viewcode-block" id="BSEMDF_Workflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.BSEMDF_Workflow">[docs]</a><span class="k">class</span> <span class="nc">BSEMDF_Workflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">bse_input</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Workflow for simple BSE calculations in which the self-energy corrections </span>
<span class="sd">        are approximated by the scissors operator and the screening in modeled </span>
<span class="sd">        with the model dielectric function.</span>

<span class="sd">        Args:</span>
<span class="sd">            scf_input:</span>
<span class="sd">                Input for the SCF run or `ScfStrategy` object.</span>
<span class="sd">            nscf_input:</span>
<span class="sd">                Input for the NSCF run or `NscfStrategy` object.</span>
<span class="sd">            bse_input:</span>
<span class="sd">                Input for the BSE run or `BSEStrategy` object.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory of the calculation.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BSEMDF_Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c"># Register the GS-SCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>

        <span class="c"># Construct the input for the NSCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">NscfTask</span><span class="p">)</span>

        <span class="c"># Construct the input for the BSE run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bse_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">bse_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">HaydockBseTask</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="PhononWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.PhononWorkflow">[docs]</a><span class="k">class</span> <span class="nc">PhononWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This workflow usually consists of nirred Phonon tasks where nirred is </span>
<span class="sd">    the number of irreducible perturbations for a given q-point.</span>
<span class="sd">    It provides the callback method (on_all_ok) that calls mrgddb to merge </span>
<span class="sd">    the partial DDB files and mrgggkk to merge the GKK files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PhononWorkflow.merge_ddb_files"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.PhononWorkflow.merge_ddb_files">[docs]</a>    <span class="k">def</span> <span class="nf">merge_ddb_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when all the q-points have been computed.</span>
<span class="sd">        Ir runs `mrgddb` in sequential on the local machine to produce</span>
<span class="sd">        the final DDB file in the outdir of the `Workflow`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_files</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s">&quot;DDB&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;will call mrgddb to merge </span><span class="si">%s</span><span class="s">:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c">#if len(ddb_files) == 1:</span>
        <span class="c"># Avoid the merge. Just move the DDB file to the outdir of the workflow</span>

        <span class="c"># Final DDB file will be produced in the outdir of the workflow.</span>
        <span class="n">out_ddb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;out_DDB&quot;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;DDB file merged by </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">())</span>

        <span class="n">mrgddb</span> <span class="o">=</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">Mrgddb</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mrgddb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">,</span> <span class="n">out_ddb</span><span class="o">=</span><span class="n">out_ddb</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PhononWorkflow.merge_gkk_files"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.PhononWorkflow.merge_gkk_files">[docs]</a>    <span class="k">def</span> <span class="nf">merge_gkk_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when all the q-points have been computed.</span>
<span class="sd">        Ir runs `mrgddb` in sequential on the local machine to produce</span>
<span class="sd">        the final DDB file in the outdir of the `Workflow`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gkk_files</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s">&quot;GKK&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>
                                                                                         
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Will call mrggkk to merge </span><span class="si">%s</span><span class="s">:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">gkk_files</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">gkk</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c">#if len(gkk) == 1:</span>
        <span class="c"># Avoid the merge. Just move the GKK file to the outdir of the workflow</span>
                                                                                         
        <span class="c"># Final GKK file will be produced in the outdir of the workflow.</span>
        <span class="n">out_ggk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;out_GKK&quot;</span><span class="p">)</span>

        <span class="n">mrggkk</span> <span class="o">=</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">Mrggkk</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Have to check mrggkk&quot;</span><span class="p">)</span>
        <span class="c">#mrggkk.merge(gswfk_file, dfpt_files, gkk_files, out_fname, binascii=0, cwd=self.outdir.path)</span>
</div>
<div class="viewcode-block" id="PhononWorkflow.on_all_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.PhononWorkflow.on_all_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when all the q-points have been computed.</span>
<span class="sd">        Ir runs `mrgddb` in sequential on the local machine to produce</span>
<span class="sd">        the final DDB file in the outdir of the `Workflow`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Merge DDB files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_ddb_files</span><span class="p">()</span>

        <span class="c"># Merge GKK files.</span>
        <span class="c">#self.merge_gkk_files()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s">&quot;DDB merge done&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

</div></div>
<span class="k">class</span> <span class="nc">WorkflowResults</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">MSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dictionary used to store some of the results produce by a Task object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_MANDATORY_KEYS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&quot;task_results&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">_EXC_KEY</span> <span class="o">=</span> <span class="s">&quot;_exceptions&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WorkflowResults</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">push_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exceptions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="n">newstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">newstr</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">assert_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns empty string if results seem valid.</span>

<span class="sd">        The try assert except trick allows one to get a string with info on the exception.</span>
<span class="sd">        We use the += operator so that sub-classes can add their own message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Validate tasks.</span>
        <span class="k">for</span> <span class="n">tres</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tres</span><span class="o">.</span><span class="n">assert_valid</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&quot;@module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&quot;@class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;@module&quot;</span><span class="p">,</span> <span class="s">&quot;@class&quot;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">pymatgen 2.8.8 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Shyue Ping Ong, Anubhav Jain, Geoffroy Hautier, William Davidson Richard, Stephen Dacek, Sai Jayaraman, Michael Kocher, Dan Gunter, Shreyas Cholia, Vincent L Chevrier, Rickard Armiento.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>