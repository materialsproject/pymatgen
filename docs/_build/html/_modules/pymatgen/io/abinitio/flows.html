
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pymatgen.io.abinitio.flows &mdash; pymatgen 2.8.8 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/proBlue.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '2.8.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="pymatgen 2.8.8 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">pymatgen 2.8.8 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pymatgen.io.abinitio.flows</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Abinit Flows</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
<span class="c">#import pickle as pickle</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pydispatch</span> <span class="kn">import</span> <span class="n">dispatcher</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">pymatgen.util.io_utils</span> <span class="kn">import</span> <span class="n">FileLock</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.string_utils</span> <span class="kn">import</span> <span class="n">pprint_table</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.tasks</span> <span class="kn">import</span> <span class="n">Dependency</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Task</span><span class="p">,</span> <span class="n">ScfTask</span><span class="p">,</span> <span class="n">PhononTask</span> 
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.utils</span> <span class="kn">import</span> <span class="n">Directory</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.abiinspect</span> <span class="kn">import</span> <span class="n">yaml_read_irred_perts</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.workflows</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">BandStructureWorkflow</span><span class="p">,</span> <span class="n">PhononWorkflow</span><span class="p">,</span> <span class="n">G0W0_Workflow</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Matteo Giantomassi&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2013, The Materials Project&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.1&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s">&quot;Matteo Giantomassi&quot;</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;AbinitFlow&quot;</span><span class="p">,</span>
    <span class="s">&quot;bandstructure_flow&quot;</span><span class="p">,</span>
    <span class="s">&quot;g0w0_flow&quot;</span><span class="p">,</span>
    <span class="s">&quot;phonon_flow&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="AbinitFlow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow">[docs]</a><span class="k">class</span> <span class="nc">AbinitFlow</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="c">#class AbinitFlow(collections.Iterable):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object is a container of workflows. Its main task is managing the </span>
<span class="sd">    possible inter-depedencies among the workflows and the creation of</span>
<span class="sd">    dynamic worfflows that are generates by callbacks registered by the user.</span>

<span class="sd">    .. attributes:</span>

<span class="sd">        creation_date:</span>
<span class="sd">            String with the creation_date</span>

<span class="sd">        pickle_protocol: </span>
<span class="sd">            Protocol for Pickle database (default: -1 i.e. latest protocol)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="s">&quot;0.1&quot;</span>

    <span class="n">PICKLE_FNAME</span> <span class="o">=</span> <span class="s">&quot;__AbinitFlow__.pickle&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">auto_restart</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pickle_protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            workdir:</span>
<span class="sd">                String specifying the directory where the workflows will be produced.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object responsible for the submission of the jobs.</span>
<span class="sd">            auto_restart:</span>
<span class="sd">                True if unconverged calculations should be restarted automatically.</span>
<span class="sd">            pickle_procol:</span>
<span class="sd">                Pickle protocol version used for saving the status of the object.</span>
<span class="sd">                -1 denotes the latest version supported by the python interpreter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AbinitFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_restart</span> <span class="o">=</span> <span class="n">auto_restart</span>

        <span class="c"># List of workflows.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_works</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># List of callbacks that must be executed when the dependencies reach S_OK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Directories with (input|output|temporary) data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;indata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;outdata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;tmpdata&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_protocol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pickle_protocol</span><span class="p">)</span>

        <span class="c"># Signal slots: a dictionary with the list </span>
        <span class="c"># of callbacks indexed by node_id and SIGNAL_TYPE.</span>
        <span class="c"># When the node changes its status, it broadcast a signal.</span>
        <span class="c"># The flow is listening to all the nodes of the calculation</span>
        <span class="c"># [node_id][SIGNAL] = list_of_signal_handlers</span>
        <span class="c">#self._sig_slots =  slots = {}</span>
        <span class="c">#for work in self:</span>
        <span class="c">#    slots[work] = {s: [] for s in work.S_ALL}</span>

        <span class="c">#for task in self.iflat_tasks():</span>
        <span class="c">#    slots[task] = {s: [] for s in work.S_ALL}</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">[</span><span class="nb">slice</span><span class="p">]</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="AbinitFlow.works"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.works">[docs]</a>    <span class="k">def</span> <span class="nf">works</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of `Workflow` objects contained in self..&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_works</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="AbinitFlow.all_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.all_ok">[docs]</a>    <span class="k">def</span> <span class="nf">all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all the tasks in workflows have reached S_OK.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">all_ok</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="c">#@property</span>
    <span class="c">#def completed(self):</span>
    <span class="c">#    &quot;&quot;&quot;True if all the tasks of the flow have reached S_OK.&quot;&quot;&quot;</span>
    <span class="c">#    return all(task.status == task.S_OK for task in self.iflat_tasks())</span>
</div>
<div class="viewcode-block" id="AbinitFlow.iflat_tasks_wti"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.iflat_tasks_wti">[docs]</a>    <span class="k">def</span> <span class="nf">iflat_tasks_wti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s">&quot;=&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (task, work_index, task_index)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iflat_tasks_wti</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AbinitFlow.iflat_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.iflat_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">iflat_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s">&quot;=&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iflat_tasks_wti</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_iflat_tasks_wti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generators that produces a flat sequence of task.</span>
<span class="sd">        if status is not None, only the tasks with the specified status are selected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (task, work_index, task_index) if with_wti is True else task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wi</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">with_wti</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">task</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get the operator from the string.</span>
            <span class="kn">import</span> <span class="nn">operator</span>
            <span class="n">op</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;=&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
                <span class="s">&quot;!=&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ne</span><span class="p">,</span>
                <span class="s">&quot;&gt;&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
                <span class="s">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
                <span class="s">&quot;&lt;&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span>
                <span class="s">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
            <span class="p">}[</span><span class="n">op</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">wi</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">op</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">with_wti</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">task</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="AbinitFlow.ncpus_reserved"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.ncpus_reserved">[docs]</a>    <span class="k">def</span> <span class="nf">ncpus_reserved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs reserved in this moment.</span>
<span class="sd">        A CPUS is reserved if it&#39;s still not running but </span>
<span class="sd">        we have submitted the task to the queue manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncpus_reverved</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="AbinitFlow.ncpus_allocated"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.ncpus_allocated">[docs]</a>    <span class="k">def</span> <span class="nf">ncpus_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs allocated in this moment.</span>
<span class="sd">        A CPU is allocated if it&#39;s running a task or if we have</span>
<span class="sd">        submitted a task to the queue manager but the job is still pending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncpus_allocated</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="AbinitFlow.ncpus_inuse"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.ncpus_inuse">[docs]</a>    <span class="k">def</span> <span class="nf">ncpus_inuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs used in this moment.</span>
<span class="sd">        A CPU is used if there&#39;s a job that is running on it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncpus_inuse</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AbinitFlow.check_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.check_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the status of the workflows in self.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>

        <span class="c"># Test whether some task should be restarted.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_restart</span><span class="p">:</span>
            <span class="n">num_restarts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">task</span><span class="p">,</span> <span class="n">wt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Task</span><span class="o">.</span><span class="n">S_UNCONVERGED</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;AbinitFlow will try restart task </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">task</span>
                <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">retcode</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">restart_if_needed</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="n">num_restarts</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">num_restarts</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;num_restarts done successfully: &quot;</span><span class="p">,</span> <span class="n">num_restarts</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AbinitFlow.show_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.show_status">[docs]</a>    <span class="k">def</span> <span class="nf">show_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Report the status of the workflows and the status </span>
<span class="sd">        of the different tasks on the specified stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="mi">80</span><span class="o">*</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Workflow #</span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">, Finalized=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">finalized</span><span class="p">)</span> <span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="p">[[</span>
                     <span class="s">&quot;Task&quot;</span><span class="p">,</span> <span class="s">&quot;Status&quot;</span><span class="p">,</span> <span class="s">&quot;Queue_id&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;Errors&quot;</span><span class="p">,</span> <span class="s">&quot;Warnings&quot;</span><span class="p">,</span> <span class="s">&quot;Comments&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;MPI&quot;</span><span class="p">,</span> <span class="s">&quot;OMP&quot;</span><span class="p">,</span> 
                     <span class="s">&quot;num_restarts&quot;</span><span class="p">,</span> <span class="s">&quot;max_restarts&quot;</span><span class="p">,</span> <span class="s">&quot;Task Class&quot;</span>
                     <span class="p">]]</span>

            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">task_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c"># Parse the events in the main output.</span>
                <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>

                <span class="n">events</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="s">&quot;N/A&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> 
                    <span class="n">events</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">report</span><span class="o">.</span><span class="n">num_errors</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_warnings</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_comments</span><span class="p">])</span>

                <span class="n">cpu_info</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">mpi_ncpus</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">omp_ncpus</span><span class="p">])</span>
                <span class="n">task_info</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">num_restarts</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">max_num_restarts</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">])</span>

                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">task_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">queue_id</span><span class="p">)]</span> <span class="o">+</span> 
                    <span class="n">events</span> <span class="o">+</span> 
                    <span class="n">cpu_info</span> <span class="o">+</span> 
                    <span class="n">task_info</span>
                    <span class="p">)</span>

            <span class="n">pprint_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AbinitFlow.build"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make directories and files of the `Flow`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AbinitFlow.build_and_pickle_dump"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.build_and_pickle_dump">[docs]</a>    <span class="k">def</span> <span class="nf">build_and_pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build dirs and file of the `Flow` and save the object in pickle format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            0 if success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AbinitFlow.pickle_dump"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.pickle_dump">[docs]</a>    <span class="k">def</span> <span class="nf">pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the status of the object in pickle format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            0 if success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_protocol</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w&quot;</span> <span class="k">if</span> <span class="n">protocol</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">)</span>

        <span class="c"># Atomic transaction.</span>
        <span class="c">#filepath_new = filepath + &quot;.new&quot;</span>
        <span class="c">#filepath_save = filepath + &quot;.save&quot;</span>
        <span class="c">#shutil.copyfile(filepath, filepath_save)</span>

        <span class="c">#try:</span>
        <span class="c">#    with open(filepath_new, mode=&quot;w&quot; if protocol == 0 else &quot;wb&quot;) as fh:</span>
        <span class="c">#        pickle.dump(self, fh, protocol=protocol)</span>

        <span class="c">#    os.rename(filepath_new, filepath)</span>
        <span class="c">#except IOError:</span>
        <span class="c">#    os.rename(filepath_save, filepath)</span>
        <span class="c">#finally:</span>
        <span class="c">#    try</span>
        <span class="c">#        os.remove(filepath_save)</span>
        <span class="c">#    except:</span>
        <span class="c">#        pass</span>
        <span class="c">#    try</span>
        <span class="c">#        os.remove(filepath_new)</span>
        <span class="c">#    except:</span>
        <span class="c">#        pass</span>
        <span class="k">return</span> <span class="mi">0</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="AbinitFlow.pickle_load"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.pickle_load">[docs]</a>    <span class="k">def</span> <span class="nf">pickle_load</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">disable_signals</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the object from a pickle file and performs initial setup.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath:</span>
<span class="sd">                Filename or directory name. It filepath is a directory, we </span>
<span class="sd">                scan the directory tree starting from filepath and we </span>
<span class="sd">                read the first pickle database.</span>
<span class="sd">            disable_signals:</span>
<span class="sd">                If True, the nodes of the flow are not connected by signals.</span>
<span class="sd">                This option is usually used when we want to read a flow </span>
<span class="sd">                in read-only mode and we want to avoid any possible side effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="c"># Walk through each directory inside path and find the pickle database.</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">cls</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fnames</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s">&quot;Cannot find </span><span class="si">%s</span><span class="s"> inside directory </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_signals</span><span class="p">:</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>

        <span class="c"># Recompute the status of each task since tasks that</span>
        <span class="c"># have been submitted previously might be completed.</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">flow</span>
</div>
<div class="viewcode-block" id="AbinitFlow.register_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.register_task">[docs]</a>    <span class="k">def</span> <span class="nf">register_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility function that generates a `Workflow` made of a single task</span>

<span class="sd">        Args:</span>
<span class="sd">            input:</span>
<span class="sd">                Abinit Input file or `Strategy` object of `Task` object.</span>
<span class="sd">            deps:</span>
<span class="sd">                List of `Dependency` objects specifying the dependency of this node.</span>
<span class="sd">                An empy list of deps implies that this node has no dependencies.</span>
<span class="sd">            manager:</span>
<span class="sd">                The `TaskManager` responsible for the submission of the task. </span>
<span class="sd">                If manager is None, we use the `TaskManager` specified during the creation of the workflow.</span>
<span class="sd">            task_class:</span>
<span class="sd">                Task subclass to instantiate. Default: `AbinitTask` </span>

<span class="sd">        Returns:   </span>
<span class="sd">            The generated `Task`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">task_class</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span>
</div>
<div class="viewcode-block" id="AbinitFlow.register_work"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.register_work">[docs]</a>    <span class="k">def</span> <span class="nf">register_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new `Workflow` and add it to the internal list, </span>
<span class="sd">        taking into account possible dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            work:</span>
<span class="sd">                `Workflow` object.</span>
<span class="sd">            deps:</span>
<span class="sd">                List of `Dependency` objects specifying the dependency of this node.</span>
<span class="sd">                An empy list of deps implies that this node has no dependencies.</span>
<span class="sd">            manager:</span>
<span class="sd">                The `TaskManager` responsible for the submission of the task. </span>
<span class="sd">                If manager is None, we use the `TaskManager` specified during the creation of the workflow.</span>
<span class="sd">            workdir:</span>
<span class="sd">                The name of the directory used for the `Workflow`.</span>

<span class="sd">        Returns:   </span>
<span class="sd">            The registered `Workflow`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Directory of the workflow.</span>
        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;work_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basenane</span><span class="p">(</span><span class="n">workdir</span><span class="p">))</span>

        <span class="n">work</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">work_workdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dependency</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">exts</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span>
</div>
<div class="viewcode-block" id="AbinitFlow.register_cbk"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.register_cbk">[docs]</a>    <span class="k">def</span> <span class="nf">register_cbk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbk</span><span class="p">,</span> <span class="n">cbk_data</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">work_class</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a callback function that will generate the `Task` of the `Workflow`.</span>

<span class="sd">        Args:</span>
<span class="sd">            cbk:</span>
<span class="sd">                Callback function.</span>
<span class="sd">            cbk_data</span>
<span class="sd">                Additional data passed to the callback function.</span>
<span class="sd">            deps:</span>
<span class="sd">                List of `Dependency` objects specifying the dependency of the workflow.</span>
<span class="sd">            work_class:</span>
<span class="sd">                `Workflow` class to instantiate.</span>
<span class="sd">            manager:</span>
<span class="sd">                The `TaskManager` responsible for the submission of the task. </span>
<span class="sd">                If manager is None, we use the `TaskManager` specified during the creation of the `Flow`.</span>
<span class="sd">                                                                                                            </span>
<span class="sd">        Returns:   </span>
<span class="sd">            The `Workflow` that will be finalized by the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: pass a workflow factory instead of a class</span>
        <span class="c"># Directory of the workflow.</span>
        <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;work_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

        <span class="c"># Create an empty workflow and register the callback</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">work_class</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">work_workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_works</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                                                                                                            
        <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dependency</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">exts</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;A callback must have deps!&quot;</span><span class="p">)</span>

        <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="c"># Wrap the callable in a Callback object and save </span>
        <span class="c"># useful info such as the index of the workflow and the callback data.</span>
        <span class="n">cbk</span> <span class="o">=</span> <span class="n">Callback</span><span class="p">(</span><span class="n">cbk</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">cbk_data</span><span class="o">=</span><span class="n">cbk_data</span><span class="p">)</span>
                                                                                                            
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbk</span><span class="p">)</span>
                                                                                                            
        <span class="k">return</span> <span class="n">work</span>
</div>
<div class="viewcode-block" id="AbinitFlow.allocate"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.allocate">[docs]</a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocate the `AbinitFlow` i.e. assign the `workdir` and (optionally) </span>
<span class="sd">        the `TaskManager` to the different tasks in the Flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>
            <span class="n">work</span><span class="o">.</span><span class="n">set_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="AbinitFlow.show_dependencies"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.show_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">show_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">show_intrawork_deps</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AbinitFlow.on_dep_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.on_dep_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_dep_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="c"># TODO</span>
        <span class="c"># Replace this callback with dynamic dispatch</span>
        <span class="c"># on_all_S_OK for workflow</span>
        <span class="c"># on_S_OK for task</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;on_dep_ok with sender </span><span class="si">%s</span><span class="s">, signal </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sender</span><span class="p">),</span> <span class="n">signal</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cbk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbk</span><span class="o">.</span><span class="n">handle_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Do not handle&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbk</span><span class="o">.</span><span class="n">can_execute</span><span class="p">():</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;cannot execute&quot;</span><span class="p">)</span>
                <span class="k">continue</span> 

            <span class="c"># Execute the callback to generate the workflow.</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;about to build new workflow&quot;</span><span class="p">)</span>
            <span class="c">#empty_work = self._works[cbk.w_idx]</span>

            <span class="c"># TODO better treatment of ids</span>
            <span class="c"># Make sure the new workflow has the same id as the previous one.</span>
            <span class="c">#new_work_idx = cbk.w_idx</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">cbk</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">cbk</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>

            <span class="c"># Disable the callback.</span>
            <span class="n">cbk</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

            <span class="c"># Update the database.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>

    <span class="c">#def finalize(self):</span>
    <span class="c">#    &quot;&quot;&quot;This method is called when the flow is completed.&quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="AbinitFlow.connect_signals"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.connect_signals">[docs]</a>    <span class="k">def</span> <span class="nf">connect_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect the signals within the workflow.</span>
<span class="sd">        self is responsible for catching the important signals raised from </span>
<span class="sd">        its task and raise new signals when some particular condition occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Connect the signals inside each Workflow.</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>

        <span class="c"># Observe the nodes that must reach S_OK in order to call the callbacks.</span>
        <span class="k">for</span> <span class="n">cbk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">cbk</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;connecting </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">with sender </span><span class="si">%s</span><span class="s">, signal </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cbk</span><span class="p">),</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span><span class="p">))</span>
                <span class="n">dispatcher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_dep_ok</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Associate to each signal the callback _on_signal</span>
        <span class="c"># (bound method of the node that will be called by `AbinitFlow`</span>
        <span class="c"># Each node will set its attribute _done_signal to True to tell</span>
        <span class="c"># the flow that this callback should be disabled.</span>

        <span class="c"># Register the callbacks for the Workflows.</span>
        <span class="c">#for work in self:</span>
        <span class="c">#    slot = self._sig_slots[work]</span>
        <span class="c">#    for signal in S_ALL:</span>
        <span class="c">#        done_signal = getattr(work, &quot;_done_ &quot; + signal, False)</span>
        <span class="c">#        if not done_sig:</span>
        <span class="c">#            cbk_name = &quot;_on_&quot; + str(signal)</span>
        <span class="c">#            cbk = getattr(work, cbk_name, None)</span>
        <span class="c">#            if cbk is None: continue</span>
        <span class="c">#            slot[work][signal].append(cbk)</span>
        <span class="c">#            print(&quot;connecting %s\nwith sender %s, signal %s&quot; % (str(cbk), dep.node, dep.node.S_OK))</span>
        <span class="c">#            dispatcher.connect(self.on_dep_ok, signal=signal, sender=dep.node, weak=False)</span>

        <span class="c"># Register the callbacks for the Tasks.</span>

        <span class="c">#self.show_receivers()</span>
</div>
<div class="viewcode-block" id="AbinitFlow.show_receivers"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.AbinitFlow.show_receivers">[docs]</a>    <span class="k">def</span> <span class="nf">show_receivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;*** live receivers ***&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">liveReceivers</span><span class="p">(</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">getReceivers</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">signal</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;receiver --&gt;&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;*** end live receivers ***&quot;</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">Callback</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">cbk_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the callback.</span>

<span class="sd">        Args:</span>
<span class="sd">            func:</span>
<span class="sd">                The function to execute. Must have signature .... TODO</span>
<span class="sd">            work:</span>
<span class="sd">                Reference to the `Workflow` that will be filled.</span>
<span class="sd">            deps:</span>
<span class="sd">                List of dependencies associated to the callback</span>
<span class="sd">            cbk_data:</span>
<span class="sd">                Additional data to pass to the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbk_data</span> <span class="o">=</span> <span class="n">cbk_data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the callback.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_execute</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;in callback&quot;</span><span class="p">)</span>
            <span class="c">#print(&quot;in callback with sender %s, signal %s&quot; % (sender, signal))</span>
            <span class="n">cbk_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbk_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c">#cbk_data[&quot;_w_idx&quot;] = self.w_idx</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">flow</span><span class="o">=</span><span class="n">flow</span><span class="p">,</span> <span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">,</span> <span class="n">cbk_data</span><span class="o">=</span><span class="n">cbk_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Cannot execute&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we can execut the callback.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="ow">and</span> <span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span>  <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the callback has been disabled.</span>
<span class="sd">        This usually happens when the callback has been executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">handle_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the callback is associated to the sender</span>
<span class="sd">        i.e. if the node who sent the signal appears in the </span>
<span class="sd">        dependencies of the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sender</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span>


<span class="c"># Factory functions.</span>
<div class="viewcode-block" id="bandstructure_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.bandstructure_flow">[docs]</a><span class="k">def</span> <span class="nf">bandstructure_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an `AbinitFlow` for band structure calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir:</span>
<span class="sd">            Working directory.</span>
<span class="sd">        manager:</span>
<span class="sd">            `TaskManager` object used to submit the jobs</span>
<span class="sd">        scf_input:</span>
<span class="sd">            Input for the GS SCF run.</span>
<span class="sd">        nscf_input:</span>
<span class="sd">            Input for the NSCF run (band structure run).</span>
<span class="sd">        dos_inputs:</span>
<span class="sd">            Input(s) for the NSCF run (dos run).</span>

<span class="sd">    Returns:</span>
<span class="sd">        `AbinitFlow`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">AbinitFlow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>
    <span class="n">work</span> <span class="o">=</span> <span class="n">BandStructureWorkflow</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="n">dos_inputs</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="g0w0_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.g0w0_flow">[docs]</a><span class="k">def</span> <span class="nf">g0w0_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an `AbinitFlow` for one-shot $G_0W_0$ calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir:</span>
<span class="sd">            Working directory.</span>
<span class="sd">        manager:</span>
<span class="sd">            `TaskManager` object used to submit the jobs</span>
<span class="sd">        scf_input:</span>
<span class="sd">            Input for the GS SCF run.</span>
<span class="sd">        nscf_input:</span>
<span class="sd">            Input for the NSCF run (band structure run).</span>
<span class="sd">        scr_input:</span>
<span class="sd">            Input for the SCR run.</span>
<span class="sd">        sigma_inputs:</span>
<span class="sd">            List of inputs for the SIGMA run.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `AbinitFlow`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">AbinitFlow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>
    <span class="n">work</span> <span class="o">=</span> <span class="n">G0W0_Workflow</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="phonon_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.flows.phonon_flow">[docs]</a><span class="k">def</span> <span class="nf">phonon_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">ph_inputs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an `AbinitFlow` for phonon calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir:</span>
<span class="sd">            Working directory.</span>
<span class="sd">        manager:</span>
<span class="sd">            `TaskManager` used to submit the jobs</span>
<span class="sd">        scf_input:</span>
<span class="sd">            Input for the GS SCF run.</span>
<span class="sd">        ph_inputs:</span>
<span class="sd">            List of Inputs for the phonon runs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `AbinitFlow`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scf_input</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

    <span class="c"># Create the container that will manage the different workflows.</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">AbinitFlow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>

    <span class="c"># Register the first workflow (GS calculation)</span>
    <span class="n">scf_task</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>

    <span class="c"># Build a temporary workflow with a shell manager just to run </span>
    <span class="c"># ABINIT to get the list of irreducible pertubations for this q-point.</span>
    <span class="n">shell_manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">to_shell_manager</span><span class="p">(</span><span class="n">mpi_ncpus</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">shell_manager</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ph_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">ph_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ph_inputs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ph_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ph_inputs</span><span class="p">):</span>
        <span class="n">fake_input</span> <span class="o">=</span> <span class="n">ph_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c"># Run abinit on the front-end to get the list of irreducible pertubations.</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;__ph_run&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;__&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">shell_manager</span><span class="p">)</span>
        <span class="n">fake_task</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fake_input</span><span class="p">)</span>
        <span class="c">#print(w)</span>
        <span class="c">#print(&quot;manager&quot;,w.manager)</span>

        <span class="c"># Use the magic value paral_rf = -1 </span>
        <span class="c"># to get the list of irreducible perturbations for this q-point.</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">paral_rf</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">rfatpol</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">natom</span><span class="p">],</span>  <span class="c"># Set of atoms to displace.</span>
                    <span class="n">rfdir</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>     <span class="c"># Along this set of reduced coordinate axis.</span>
                   <span class="p">)</span>

        <span class="n">fake_task</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">add_extra_abivars</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Parse the file to get the perturbations.</span>
        <span class="n">irred_perts</span> <span class="o">=</span> <span class="n">yaml_read_irred_perts</span><span class="p">(</span><span class="n">fake_task</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">irred_perts</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">rmtree</span><span class="p">()</span>

        <span class="c"># Now we can build the final list of workflows:</span>
        <span class="c"># One workflow per q-point, each workflow computes all </span>
        <span class="c"># the irreducible perturbations for a singe q-point.</span>
        <span class="n">work_qpt</span> <span class="o">=</span> <span class="n">PhononWorkflow</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">irred_pert</span> <span class="ow">in</span> <span class="n">irred_perts</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">irred_pert</span><span class="p">)</span>
            <span class="n">new_input</span> <span class="o">=</span> <span class="n">ph_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

            <span class="c">#rfatpol   1 1   # Only the first atom is displaced</span>
            <span class="c">#rfdir   1 0 0   # Along the first reduced coordinate axis</span>
            <span class="n">qpt</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s">&quot;qpt&quot;</span><span class="p">]</span>
            <span class="n">idir</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s">&quot;idir&quot;</span><span class="p">]</span>
            <span class="n">ipert</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s">&quot;ipert&quot;</span><span class="p">]</span>

            <span class="c"># TODO this will work for phonons, but not for the other types of perturbations.</span>
            <span class="n">rfdir</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rfdir</span><span class="p">[</span><span class="n">idir</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rfatpol</span> <span class="o">=</span> <span class="p">[</span><span class="n">ipert</span><span class="p">,</span> <span class="n">ipert</span><span class="p">]</span>

            <span class="n">new_input</span><span class="o">.</span><span class="n">set_variables</span><span class="p">(</span>
                <span class="c">#rfpert=1,</span>
                <span class="n">qpt</span><span class="o">=</span><span class="n">qpt</span><span class="p">,</span>
                <span class="n">rfdir</span><span class="o">=</span><span class="n">rfdir</span><span class="p">,</span>
                <span class="n">rfatpol</span><span class="o">=</span><span class="n">rfatpol</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">work_qpt</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">new_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">PhononTask</span><span class="p">)</span>

        <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work_qpt</span><span class="p">)</span>
                                            
    <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">pymatgen 2.8.8 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Shyue Ping Ong, Anubhav Jain, Geoffroy Hautier, William Davidson Richard, Stephen Dacek, Sai Jayaraman, Michael Kocher, Dan Gunter, Shreyas Cholia, Vincent L Chevrier, Rickard Armiento.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>