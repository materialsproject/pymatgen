
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pymatgen.io.abinit.flows &#8212; pymatgen 2018.9.12 documentation</title>
    <link rel="stylesheet" href="../../../../_static/proBlue.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 2018.9.12 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../pymatgen.html" accesskey="U">pymatgen</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymatgen.io.abinit.flows</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="c1"># Copyright (c) Pymatgen Development Team.</span>
<span class="c1"># Distributed under the terms of the MIT License.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A Flow is a container for Works, and works consist of tasks.</span>
<span class="sd">Flows are the final objects that can be dumped directly to a pickle file on disk</span>
<span class="sd">Flows are executed using abirun (abipy).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="nb">map</span><span class="p">,</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span>
<span class="kn">from</span> <span class="nn">pydispatch</span> <span class="k">import</span> <span class="n">dispatcher</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="k">import</span> <span class="n">as_set</span><span class="p">,</span> <span class="n">dict2namedtuple</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="k">import</span> <span class="n">list_strings</span><span class="p">,</span> <span class="n">is_string</span><span class="p">,</span> <span class="n">make_banner</span>
<span class="kn">from</span> <span class="nn">monty.operator</span> <span class="k">import</span> <span class="n">operator_from_str</span>
<span class="kn">from</span> <span class="nn">monty.io</span> <span class="k">import</span> <span class="n">FileLock</span>
<span class="kn">from</span> <span class="nn">monty.pprint</span> <span class="k">import</span> <span class="n">draw_tree</span>
<span class="kn">from</span> <span class="nn">monty.termcolor</span> <span class="k">import</span> <span class="n">cprint</span><span class="p">,</span> <span class="n">colored</span><span class="p">,</span> <span class="n">cprint_map</span><span class="p">,</span> <span class="n">get_terminal_size</span>
<span class="kn">from</span> <span class="nn">monty.inspect</span> <span class="k">import</span> <span class="n">find_top_pyfile</span>
<span class="kn">from</span> <span class="nn">monty.dev</span> <span class="k">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="k">import</span> <span class="n">MSONable</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.serialization</span> <span class="k">import</span> <span class="n">pmg_pickle_load</span><span class="p">,</span> <span class="n">pmg_pickle_dump</span><span class="p">,</span> <span class="n">pmg_serialize</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="k">import</span> <span class="n">Memory</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.io_utils</span> <span class="k">import</span> <span class="n">AtomicFile</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.plotting</span> <span class="k">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">wrappers</span>
<span class="kn">from</span> <span class="nn">.nodes</span> <span class="k">import</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">NodeError</span><span class="p">,</span> <span class="n">NodeResults</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">,</span> <span class="n">GarbageCollector</span><span class="p">,</span> <span class="n">check_spectator</span>
<span class="kn">from</span> <span class="nn">.tasks</span> <span class="k">import</span> <span class="n">ScfTask</span><span class="p">,</span> <span class="n">DdkTask</span><span class="p">,</span> <span class="n">DdeTask</span><span class="p">,</span> <span class="n">TaskManager</span><span class="p">,</span> <span class="n">FixQueueCriticalError</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">File</span><span class="p">,</span> <span class="n">Directory</span><span class="p">,</span> <span class="n">Editor</span>
<span class="kn">from</span> <span class="nn">.abiinspect</span> <span class="k">import</span> <span class="n">yaml_read_irred_perts</span>
<span class="kn">from</span> <span class="nn">.works</span> <span class="k">import</span> <span class="n">NodeContainer</span><span class="p">,</span> <span class="n">Work</span><span class="p">,</span> <span class="n">BandStructureWork</span><span class="p">,</span> <span class="n">PhononWork</span><span class="p">,</span> <span class="n">BecWork</span><span class="p">,</span> <span class="n">G0W0Work</span><span class="p">,</span> <span class="n">QptdmWork</span><span class="p">,</span> <span class="n">DteWork</span>
<span class="kn">from</span> <span class="nn">.events</span> <span class="k">import</span> <span class="n">EventsParser</span> <span class="c1"># autodoc_event_handlers</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Matteo Giantomassi&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2013, The Materials Project&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.1&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Matteo Giantomassi&quot;</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Flow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;G0W0WithQptdmFlow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bandstructure_flow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;g0w0_flow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phonon_flow&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">FlowResults</span><span class="p">(</span><span class="n">NodeResults</span><span class="p">):</span>

    <span class="n">JSON_SCHEMA</span> <span class="o">=</span> <span class="n">NodeResults</span><span class="o">.</span><span class="n">JSON_SCHEMA</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1">#JSON_SCHEMA[&quot;properties&quot;] = {</span>
    <span class="c1">#    &quot;queries&quot;: {&quot;type&quot;: &quot;string&quot;, &quot;required&quot;: True},</span>
    <span class="c1">#}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_node</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an instance from a Work instance.&quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FlowResults</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_node</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>

        <span class="c1"># Will put all files found in outdir in GridFs</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flow</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">list_filepaths</span><span class="p">()}</span>

        <span class="c1"># Add the pickle file.</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pickle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">pickle_file</span> <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">pickle_protocol</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">pickle_file</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">add_gridfs_files</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new</span>


<span class="k">class</span> <span class="nc">FlowError</span><span class="p">(</span><span class="n">NodeError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base Exception for :class:`Node` methods&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow">[docs]</a><span class="k">class</span> <span class="nc">Flow</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">NodeContainer</span><span class="p">,</span> <span class="n">MSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object is a container of work. Its main task is managing the</span>
<span class="sd">    possible inter-dependencies among the work and the creation of</span>
<span class="sd">    dynamic workflows that are generated by callbacks registered by the user.</span>

<span class="sd">    .. attributes::</span>

<span class="sd">        creation_date: String with the creation_date</span>
<span class="sd">        pickle_protocol: Protocol for Pickle database (default: -1 i.e. latest protocol)</span>

<span class="sd">    Important methods for constructing flows:</span>

<span class="sd">    .. methods::</span>

<span class="sd">        register_work: register (add) a work to the flow</span>
<span class="sd">        resister_task: register a work that contains only this task returns the work</span>
<span class="sd">        allocate: propagate the workdir and manager of the flow to all the registered tasks</span>
<span class="sd">        build:</span>
<span class="sd">        build_and_pickle_dump:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="s2">&quot;0.1&quot;</span>
    <span class="n">PICKLE_FNAME</span> <span class="o">=</span> <span class="s2">&quot;__AbinitFlow__.pickle&quot;</span>

    <span class="n">Error</span> <span class="o">=</span> <span class="n">FlowError</span>

    <span class="n">Results</span> <span class="o">=</span> <span class="n">FlowResults</span>

<div class="viewcode-block" id="Flow.from_inputs"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.from_inputs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_inputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pickle_protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">,</span>
                    <span class="n">work_class</span><span class="o">=</span><span class="n">Work</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a simple flow from a list of inputs. The flow contains a single Work with</span>
<span class="sd">        tasks whose class is given by task_class.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Don&#39;t use this interface if you have dependencies among the tasks.</span>

<span class="sd">        Args:</span>
<span class="sd">            workdir: String specifying the directory where the works will be produced.</span>
<span class="sd">            inputs: List of inputs.</span>
<span class="sd">            manager: :class:`TaskManager` object responsible for the submission of the jobs.</span>
<span class="sd">                If manager is None, the object is initialized from the yaml file</span>
<span class="sd">                located either in the working directory or in the user configuration dir.</span>
<span class="sd">            pickle_protocol: Pickle protocol version used for saving the status of the object.</span>
<span class="sd">                -1 denotes the latest version supported by the python interpreter.</span>
<span class="sd">            task_class: The class of the :class:`Task`.</span>
<span class="sd">            work_class: The class of the :class:`Work`.</span>
<span class="sd">            remove: attempt to remove working directory `workdir` if directory already exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputs</span><span class="p">]</span>

        <span class="n">flow</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">,</span> <span class="n">pickle_protocol</span><span class="o">=</span><span class="n">pickle_protocol</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="n">remove</span><span class="p">)</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">work_class</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">task_class</span><span class="p">)</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span></div>

<div class="viewcode-block" id="Flow.as_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.as_flow">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">as_flow</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert obj into a Flow. Accepts filepath, dict, or Flow object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span> <span class="k">return</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pickle_load</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know how to convert type </span><span class="si">%s</span><span class="s2"> into a Flow&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pickle_protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            workdir: String specifying the directory where the works will be produced.</span>
<span class="sd">                     if workdir is None, the initialization of the working directory</span>
<span class="sd">                     is performed by flow.allocate(workdir).</span>
<span class="sd">            manager: :class:`TaskManager` object responsible for the submission of the jobs.</span>
<span class="sd">                     If manager is None, the object is initialized from the yaml file</span>
<span class="sd">                     located either in the working directory or in the user configuration dir.</span>
<span class="sd">            pickle_protocol: Pickle protocol version used for saving the status of the object.</span>
<span class="sd">                          -1 denotes the latest version supported by the python interpreter.</span>
<span class="sd">            remove: attempt to remove working directory `workdir` if directory already exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Flow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">workdir</span><span class="p">):</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">TaskManager</span><span class="o">.</span><span class="n">from_user_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c1"># List of works.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_works</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_waited</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># List of callbacks that must be executed when the dependencies reach S_OK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Install default list of handlers at the flow level.</span>
        <span class="c1"># Users can override the default list by calling flow.install_event_handlers in the script.</span>
        <span class="c1"># Example:</span>
        <span class="c1">#</span>
        <span class="c1">#    # flow level (common case)</span>
        <span class="c1">#    flow.install_event_handlers(handlers=my_handlers)</span>
        <span class="c1">#</span>
        <span class="c1">#    # task level (advanced mode)</span>
        <span class="c1">#    flow[0][0].install_event_handlers(handlers=my_handlers)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_event_handlers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_protocol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pickle_protocol</span><span class="p">)</span>

        <span class="c1"># ID used to access mongodb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Save the location of the script used to generate the flow.</span>
        <span class="c1"># This trick won&#39;t work if we are running with nosetests, py.test etc</span>
        <span class="n">pyfile</span> <span class="o">=</span> <span class="n">find_top_pyfile</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;python&quot;</span> <span class="ow">in</span> <span class="n">pyfile</span> <span class="ow">or</span> <span class="s2">&quot;ipython&quot;</span> <span class="ow">in</span> <span class="n">pyfile</span><span class="p">:</span> <span class="n">pyfile</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">pyfile</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pyfile</span><span class="p">(</span><span class="n">pyfile</span><span class="p">)</span>

        <span class="c1"># TODO</span>
        <span class="c1"># Signal slots: a dictionary with the list</span>
        <span class="c1"># of callbacks indexed by node_id and SIGNAL_TYPE.</span>
        <span class="c1"># When the node changes its status, it broadcast a signal.</span>
        <span class="c1"># The flow is listening to all the nodes of the calculation</span>
        <span class="c1"># [node_id][SIGNAL] = list_of_signal_handlers</span>
        <span class="c1">#self._sig_slots =  slots = {}</span>
        <span class="c1">#for work in self:</span>
        <span class="c1">#    slots[work] = {s: [] for s in work.S_ALL}</span>

        <span class="c1">#for task in self.iflat_tasks():</span>
        <span class="c1">#    slots[task] = {s: [] for s in work.S_ALL}</span>

<div class="viewcode-block" id="Flow.as_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.as_dict">[docs]</a>    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        JSON serialization, note that we only need to save</span>
<span class="sd">        a string with the working directory since the object will be</span>
<span class="sd">        reconstructed from the pickle file located in workdir</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;workdir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">}</span></div>

    <span class="c1"># This is needed for fireworks.</span>
    <span class="n">to_dict</span> <span class="o">=</span> <span class="n">as_dict</span>

<div class="viewcode-block" id="Flow.from_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reconstruct the flow from the pickle file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pickle_load</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;workdir&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.temporary_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.temporary_flow">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">temporary_flow</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Flow in a temporary directory. Useful for unit tests.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(),</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.set_workdir"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">chroot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the working directory. Cannot be set more than once unless chroot is True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chroot</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;workdir&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">!=</span> <span class="n">workdir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.workdir != workdir: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>  <span class="n">workdir</span><span class="p">))</span>

        <span class="c1"># Directories with (input|output|temporary) data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;indata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;outdata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;tmpdata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.reload"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.reload">[docs]</a>    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reload the flow from the pickle file. Used when we are monitoring the flow</span>
<span class="sd">        executed by the scheduler. In this case, indeed, the flow might have been changed</span>
<span class="sd">        by the scheduler and we have to reload the new flow in memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">pickle_load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">new</span></div>

<div class="viewcode-block" id="Flow.pickle_load"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.pickle_load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pickle_load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">spectator_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_lock</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the object from a pickle file and performs initial setup.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: Filename or directory name. It filepath is a directory, we</span>
<span class="sd">                scan the directory tree starting from filepath and we</span>
<span class="sd">                read the first pickle database. Raise RuntimeError if multiple</span>
<span class="sd">                databases are found.</span>
<span class="sd">            spectator_mode: If True, the nodes of the flow are not connected by signals.</span>
<span class="sd">                This option is usually used when we want to read a flow</span>
<span class="sd">                in read-only mode and we want to avoid callbacks that can change the flow.</span>
<span class="sd">            remove_lock:</span>
<span class="sd">                True to remove the file lock if any (use it carefully).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="c1"># Walk through each directory inside path and find the pickle database.</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span> <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fnames</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">break</span>  <span class="c1"># Exit os.walk</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Found multiple databases:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find </span><span class="si">%s</span><span class="s2"> inside directory </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_lock</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="n">pmg_pickle_load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

        <span class="c1"># Check if versions match.</span>
        <span class="k">if</span> <span class="n">flow</span><span class="o">.</span><span class="n">VERSION</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">VERSION</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;File flow version </span><span class="si">%s</span><span class="s2"> != latest version </span><span class="si">%s</span><span class="se">\n</span><span class="s2">.&quot;</span>
                   <span class="s2">&quot;Regenerate the flow to solve the problem &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flow</span><span class="o">.</span><span class="n">VERSION</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">VERSION</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">flow</span><span class="o">.</span><span class="n">set_spectator_mode</span><span class="p">(</span><span class="n">spectator_mode</span><span class="p">)</span>

        <span class="c1"># Recompute the status of each task since tasks that</span>
        <span class="c1"># have been submitted previously might be completed.</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">flow</span></div>

<div class="viewcode-block" id="Flow.pickle_loads"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.pickle_loads">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pickle_loads</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reconstruct the flow from a string.&quot;&quot;&quot;</span>
        <span class="n">strio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">strio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">strio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">pmg_pickle_load</span><span class="p">(</span><span class="n">strio</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flow</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">[</span><span class="nb">slice</span><span class="p">]</span>

<div class="viewcode-block" id="Flow.set_pyfile"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.set_pyfile">[docs]</a>    <span class="k">def</span> <span class="nf">set_pyfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pyfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the path of the python script used to generate the flow.</span>

<span class="sd">        .. Example:</span>

<span class="sd">            flow.set_pyfile(__file__)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Could use a frame hack to get the caller outside abinit</span>
        <span class="c1"># so that pyfile is automatically set when we __init__ it!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">pyfile</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pyfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Absolute path of the python script used to generate the flow. Set by `set_pyfile`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyfile</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pid_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The path of the pid file created by PyFlowScheduler.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;_PyFlowScheduler.pid&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if there&#39;s a scheduler running the flow.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid_file</span><span class="p">)</span>

<div class="viewcode-block" id="Flow.check_pid_file"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.check_pid_file">[docs]</a>    <span class="k">def</span> <span class="nf">check_pid_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function checks if we are already running the :class:`Flow` with a :class:`PyFlowScheduler`.</span>
<span class="sd">        Raises: Flow.Error if the pid file of the scheduler exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_status</span><span class="p">()</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\n\</span>
<span class="s2">            pid_file</span>
<span class="s2">            </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            already exists. There are two possibilities:</span>

<span class="s2">               1) There&#39;s an another instance of PyFlowScheduler running</span>
<span class="s2">               2) The previous scheduler didn&#39;t exit in a clean way</span>

<span class="s2">            To solve case 1:</span>
<span class="s2">               Kill the previous scheduler (use &#39;kill pid&#39; where pid is the number reported in the file)</span>
<span class="s2">               Then you can restart the new scheduler.</span>

<span class="s2">            To solve case 2:</span>
<span class="s2">               Remove the pid_file and restart the scheduler.</span>

<span class="s2">            Exiting&quot;&quot;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pickle_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The path of the pickle file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PICKLE_FNAME</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mongo_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_id</span>

    <span class="nd">@mongo_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mongo_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mongo_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot change mongo_id </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mongo_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mongo_id</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Flow.mongodb_upload"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.mongodb_upload">[docs]</a>    <span class="k">def</span> <span class="nf">mongodb_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">abiflows.core.scheduler</span> <span class="k">import</span> <span class="n">FlowUploader</span>
        <span class="n">FlowUploader</span><span class="p">()</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.validate_json_schema"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.validate_json_schema">[docs]</a>    <span class="k">def</span> <span class="nf">validate_json_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the JSON schema. Return list of errors.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span><span class="o">.</span><span class="n">validate_json_schema</span><span class="p">():</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">work</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span><span class="o">.</span><span class="n">validate_json_schema</span><span class="p">():</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span><span class="o">.</span><span class="n">validate_json_schema</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span></div>

<div class="viewcode-block" id="Flow.get_mongo_info"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.get_mongo_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_mongo_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a JSON dictionary with information on the flow.</span>
<span class="sd">        Mainly used for constructing the info section in `FlowEntry`.</span>
<span class="sd">        The default implementation is empty. Subclasses must implement it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Flow.mongo_assimilate"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.mongo_assimilate">[docs]</a>    <span class="k">def</span> <span class="nf">mongo_assimilate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called by client code when the flow is completed</span>
<span class="sd">        Return a JSON dictionary with the most important results produced</span>
<span class="sd">        by the flow. The default implementation is empty. Subclasses must implement it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">works</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of :class:`Work` objects contained in self..&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_works</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all the tasks in works have reached `S_OK`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">all_ok</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Total number of tasks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">()))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errored_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of errored tasks.&quot;&quot;&quot;</span>
        <span class="n">etasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">S_ERROR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_QCRITICAL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_ABICRITICAL</span><span class="p">]:</span>
            <span class="n">etasks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)))</span>

        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">etasks</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_errored_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of tasks whose status is `S_ERROR`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errored_tasks</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unconverged_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of unconverged tasks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_UNCONVERGED</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_unconverged_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of tasks whose status is `S_UNCONVERGED`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unconverged_tasks</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a :class:`Counter` object that counts the number of tasks with</span>
<span class="sd">        given status (use the string representation of the status as key).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Count the number of tasks with given status in each work.</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status_counter</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="n">work</span><span class="o">.</span><span class="n">status_counter</span>

        <span class="k">return</span> <span class="n">counter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncores_reserved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of cores reserved in this moment.</span>
<span class="sd">        A core is reserved if the task is not running but</span>
<span class="sd">        we have submitted the task to the queue manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncores_reserved</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncores_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of cores allocated in this moment.</span>
<span class="sd">        A core is allocated if it&#39;s running a task or if we have</span>
<span class="sd">        submitted a task to the queue manager but the job is still pending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncores_allocated</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncores_used</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of cores used in this moment.</span>
<span class="sd">        A core is used if there&#39;s a job that is running on it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">ncores_used</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_chrooted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string that evaluates to True if we have changed</span>
<span class="sd">        the workdir for visualization purposes e.g. we are using sshfs.</span>
<span class="sd">        to mount the remote directory where the `Flow` is located.</span>
<span class="sd">        The string gives the previous workdir of the flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chrooted_from</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="Flow.chroot"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.chroot">[docs]</a>    <span class="k">def</span> <span class="nf">chroot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_workdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the workir of the :class:`Flow`. Mainly used for</span>
<span class="sd">        allowing the user to open the GUI on the local host</span>
<span class="sd">        and access the flow from remote via sshfs.</span>

<span class="sd">        .. note::</span>
<span class="sd">            Calling this method will make the flow go in read-only mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chrooted_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">new_workdir</span><span class="p">,</span> <span class="n">chroot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">new_wdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">work</span><span class="o">.</span><span class="n">chroot</span><span class="p">(</span><span class="n">new_wdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.groupby_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.groupby_status">[docs]</a>    <span class="k">def</span> <span class="nf">groupby_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a ordered dictionary mapping the task status to</span>
<span class="sd">        the list of named tuples (task, work_index, task_index).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Entry</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Entry&quot;</span><span class="p">,</span> <span class="s2">&quot;task wi ti&quot;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks_wti</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Entry</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span><span class="p">))</span>

        <span class="c1"># Sort keys according to their status.</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))])</span></div>

<div class="viewcode-block" id="Flow.groupby_task_class"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.groupby_task_class">[docs]</a>    <span class="k">def</span> <span class="nf">groupby_task_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary mapping the task class to the list of tasks in the flow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find all Task classes</span>
        <span class="n">class2tasks</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class2tasks</span><span class="p">:</span> <span class="n">class2tasks</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">class2tasks</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">class2tasks</span></div>

<div class="viewcode-block" id="Flow.iflat_nodes"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.iflat_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">iflat_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generators that produces a flat sequence of nodes.</span>
<span class="sd">        if status is not None, only the tasks with the specified status are selected.</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nids</span> <span class="o">=</span> <span class="n">as_set</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nids</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span>

            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">yield</span> <span class="n">work</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">yield</span> <span class="n">task</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the operator from the string.</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">operator_from_str</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

            <span class="c1"># Accept Task.S_FLAG or string.</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">as_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">nids</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span> <span class="k">yield</span> <span class="bp">self</span>

            <span class="k">for</span> <span class="n">wi</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">op</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span> <span class="k">yield</span> <span class="n">work</span>

                <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">op</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span> <span class="k">yield</span> <span class="n">task</span></div>

<div class="viewcode-block" id="Flow.node_from_nid"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.node_from_nid">[docs]</a>    <span class="k">def</span> <span class="nf">node_from_nid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the node in the `Flow` with the given `nid` identifier&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span> <span class="o">==</span> <span class="n">nid</span><span class="p">:</span> <span class="k">return</span> <span class="n">node</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find node with node id: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.iflat_tasks_wti"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.iflat_tasks_wti">[docs]</a>    <span class="k">def</span> <span class="nf">iflat_tasks_wti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator to iterate over all the tasks of the `Flow`.</span>
<span class="sd">        Yields:</span>

<span class="sd">            (task, work_index, task_index)</span>

<span class="sd">        If status is not None, only the tasks whose status satisfies</span>
<span class="sd">        the condition (task.status op status) are selected</span>
<span class="sd">        status can be either one of the flags defined in the :class:`Task` class</span>
<span class="sd">        (e.g Task.S_OK) or a string e.g &quot;S_OK&quot;</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iflat_tasks_wti</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.iflat_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.iflat_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">iflat_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator to iterate over all the tasks of the :class:`Flow`.</span>

<span class="sd">        If status is not None, only the tasks whose status satisfies</span>
<span class="sd">        the condition (task.status op status) are selected</span>
<span class="sd">        status can be either one of the flags defined in the :class:`Task` class</span>
<span class="sd">        (e.g Task.S_OK) or a string e.g &quot;S_OK&quot;</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iflat_tasks_wti</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_iflat_tasks_wti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_wti</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generators that produces a flat sequence of task.</span>
<span class="sd">        if status is not None, only the tasks with the specified status are selected.</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the tasks.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (task, work_index, task_index) if with_wti is True else task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nids</span> <span class="o">=</span> <span class="n">as_set</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wi</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">with_wti</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">task</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the operator from the string.</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">operator_from_str</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

            <span class="c1"># Accept Task.S_FLAG or string.</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">as_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">wi</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">op</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">with_wti</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">task</span><span class="p">,</span> <span class="n">wi</span><span class="p">,</span> <span class="n">ti</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">task</span>

<div class="viewcode-block" id="Flow.abivalidate_inputs"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.abivalidate_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">abivalidate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run ABINIT in dry mode to validate all the inputs of the flow.</span>

<span class="sd">        Return:</span>
<span class="sd">            (isok, tuples)</span>

<span class="sd">            isok is True if all inputs are ok.</span>
<span class="sd">            tuples is List of `namedtuple` objects, one for each task in the flow.</span>
<span class="sd">            Each namedtuple has the following attributes:</span>

<span class="sd">                retcode: Return code. 0 if OK.</span>
<span class="sd">                log_file:  log file of the Abinit run, use log_file.read() to access its content.</span>
<span class="sd">                stderr_file: stderr file of the Abinit run. use stderr_file.read() to access its content.</span>

<span class="sd">        Raises:</span>
<span class="sd">            `RuntimeError` if executable is not in $PATH.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

        <span class="n">isok</span><span class="p">,</span> <span class="n">tuples</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">abivalidate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">isok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">isok</span><span class="p">,</span> <span class="n">tuples</span></div>

<div class="viewcode-block" id="Flow.check_dependencies"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.check_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">check_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test the dependencies of the nodes for possible deadlocks.&quot;&quot;&quot;</span>
        <span class="n">deadlocks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
                    <span class="n">deadlocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">task</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">deadlocks</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Detect wrong list of dependecies that will lead to a deadlock:&quot;</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &lt;--&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nodes</span> <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">deadlocks</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></div>

<div class="viewcode-block" id="Flow.find_deadlocks"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.find_deadlocks">[docs]</a>    <span class="k">def</span> <span class="nf">find_deadlocks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function detects deadlocks</span>

<span class="sd">        Return:</span>
<span class="sd">            named tuple with the tasks grouped in: deadlocks, runnables, running</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find jobs that can be submitted and and the jobs that are already in the queue.</span>
        <span class="n">runnables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">runnables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">fetch_alltasks_to_run</span><span class="p">())</span>
        <span class="n">runnables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_SUB</span><span class="p">)))</span>

        <span class="c1"># Running jobs.</span>
        <span class="n">running</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_RUN</span><span class="p">))</span>

        <span class="c1"># Find deadlocks.</span>
        <span class="n">err_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errored_tasks</span>
        <span class="n">deadlocked</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">err_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">err_task</span><span class="p">)</span> <span class="k">for</span> <span class="n">err_task</span> <span class="ow">in</span> <span class="n">err_tasks</span><span class="p">):</span>
                    <span class="n">deadlocked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">deadlocked</span><span class="o">=</span><span class="n">deadlocked</span><span class="p">,</span> <span class="n">runnables</span><span class="o">=</span><span class="n">runnables</span><span class="p">,</span> <span class="n">running</span><span class="o">=</span><span class="n">running</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.check_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.check_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the status of the works in self.</span>

<span class="sd">        Args:</span>
<span class="sd">            show: True to show the status of the flow.</span>
<span class="sd">            kwargs: keyword arguments passed to show_status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_status</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The status of the :class:`Flow` i.e. the minimum of the status of its tasks and its works&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">get_all_status</span><span class="p">(</span><span class="n">only_min</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="c1">#def restart_unconverged_tasks(self, max_nlauch, excs):</span>
    <span class="c1">#    nlaunch = 0</span>
    <span class="c1">#    for task in self.unconverged_tasks:</span>
    <span class="c1">#        try:</span>
    <span class="c1">#            logger.info(&quot;Flow will try restart task %s&quot; % task)</span>
    <span class="c1">#            fired = task.restart()</span>
    <span class="c1">#            if fired:</span>
    <span class="c1">#                nlaunch += 1</span>
    <span class="c1">#                max_nlaunch -= 1</span>

    <span class="c1">#                if max_nlaunch == 0:</span>
    <span class="c1">#                    logger.info(&quot;Restart: too many jobs in the queue, returning&quot;)</span>
    <span class="c1">#                    self.pickle_dump()</span>
    <span class="c1">#                    return nlaunch, max_nlaunch</span>

    <span class="c1">#        except task.RestartError:</span>
    <span class="c1">#            excs.append(straceback())</span>

    <span class="c1">#    return nlaunch, max_nlaunch</span>

<div class="viewcode-block" id="Flow.fix_abicritical"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.fix_abicritical">[docs]</a>    <span class="k">def</span> <span class="nf">fix_abicritical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function tries to fix critical events originating from ABINIT.</span>
<span class="sd">        Returns the number of tasks that have been fixed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_ABICRITICAL</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">fix_abicritical</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="Flow.fix_queue_critical"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.fix_queue_critical">[docs]</a>    <span class="k">def</span> <span class="nf">fix_queue_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function tries to fix critical events originating from the queue submission system.</span>

<span class="sd">        Returns the number of tasks that have been fixed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_QCRITICAL</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will try to fix task </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">fix_queue_critical</span><span class="p">())</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="n">FixQueueCriticalError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not able to fix task </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="Flow.show_info"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_info">[docs]</a>    <span class="k">def</span> <span class="nf">show_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print info on the flow i.e. total number of tasks, works, tasks grouped by class.</span>

<span class="sd">        Example:</span>

<span class="sd">            Task Class      Number</span>
<span class="sd">            ------------  --------</span>
<span class="sd">            ScfTask              1</span>
<span class="sd">            NscfTask             1</span>
<span class="sd">            ScrTask              2</span>
<span class="sd">            SigmaTask            6</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of works: </span><span class="si">%d</span><span class="s2">, total number of tasks: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;Number of tasks with a given class:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Build Table</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)]</span>
                <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">tasks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupby_task_class</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Task Class&quot;</span><span class="p">,</span> <span class="s2">&quot;Number&quot;</span><span class="p">])))</span>

        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span></div>

<div class="viewcode-block" id="Flow.show_summary"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_summary">[docs]</a>    <span class="k">def</span> <span class="nf">show_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a short summary with the status of the flow and a counter task_status --&gt; number_of_tasks</span>

<span class="sd">        Args:</span>
<span class="sd">            stream: File-like object, Default: sys.stdout</span>

<span class="sd">        Example:</span>

<span class="sd">            Status       Count</span>
<span class="sd">            ---------  -------</span>
<span class="sd">            Completed       10</span>

<span class="sd">            &lt;Flow, node_id=27163, workdir=flow_gwconv_ecuteps&gt;, num_tasks=10, all_ok=True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_counter</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="s2">&quot;Count&quot;</span><span class="p">])</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, num_tasks=</span><span class="si">%s</span><span class="s2">, all_ok=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ok</span><span class="p">))</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.show_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_status">[docs]</a>    <span class="k">def</span> <span class="nf">show_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Report the status of the works and the status  of the different tasks on the specified stream.</span>

<span class="sd">        Args:</span>
<span class="sd">            stream: File-like object, Default: sys.stdout</span>
<span class="sd">            nids:  List of node identifiers. By defaults all nodes are shown</span>
<span class="sd">            wslice: Slice object used to select works.</span>
<span class="sd">            verbose: Verbosity level (default 0). &gt; 0 to show only the works that are not finalized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">nids</span> <span class="o">=</span> <span class="n">as_set</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">wslice</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;wslice&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">wlist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">wslice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Convert range to list of work indices.</span>
            <span class="n">wlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">wslice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">wslice</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">wslice</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>

        <span class="c1">#has_colours = stream_has_colours(stream)</span>
        <span class="n">has_colours</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">red</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span> <span class="k">if</span> <span class="n">has_colours</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">cprint_map</span><span class="p">(</span><span class="s2">&quot;Work #</span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">, Finalized=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">finalized</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;True&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">},</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wlist</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">work</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Finalized works are not shown. Use verbose &gt; 0 to force output.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="s2">&quot;Queue&quot;</span><span class="p">,</span> <span class="s2">&quot;MPI|Omp|Gb&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Warn|Com&quot;</span><span class="p">,</span> <span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;Sub|Rest|Corr&quot;</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Node_ID&quot;</span><span class="p">]</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tot_num_errors</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nids</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nids</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">task_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># FIXME: This should not be done here.</span>
                <span class="c1"># get_event_report should be called only in check_status</span>
                <span class="c1"># Parse the events in the main output.</span>
                <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>

                <span class="c1"># Get time info (run-time or time in queue or None)</span>
                <span class="n">stime</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">timedelta</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">get_runtime</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">timedelta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">stime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timedelta</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;R&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">timedelta</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">get_time_inqueue</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">timedelta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">stime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timedelta</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;Q&quot;</span>

                <span class="n">events</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">events</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:&gt;4}</span><span class="s1">|</span><span class="si">{:&gt;3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span>
                       <span class="n">report</span><span class="o">.</span><span class="n">num_warnings</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_comments</span><span class="p">)))</span>

                <span class="n">para_info</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:&gt;4}</span><span class="s1">|</span><span class="si">{:&gt;3}</span><span class="s1">|</span><span class="si">{:&gt;3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span>
                   <span class="n">task</span><span class="o">.</span><span class="n">mpi_procs</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">omp_threads</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="o">.</span><span class="n">mem_per_proc</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;Gb&quot;</span><span class="p">))))</span>

                <span class="n">task_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">num_launches</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">num_restarts</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">num_corrections</span><span class="p">),</span> <span class="n">stime</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node_id</span><span class="p">]))</span>

                <span class="n">qinfo</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">queue_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">qname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">qname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">qname</span> <span class="o">=</span> <span class="n">qname</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qname</span><span class="p">))]</span>
                    <span class="n">qinfo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">queue_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="n">qname</span>

                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_critical</span><span class="p">:</span>
                    <span class="n">tot_num_errors</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">task_name</span> <span class="o">=</span> <span class="n">colored</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="n">red</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">has_colours</span><span class="p">:</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">task_name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">colored</span><span class="p">,</span> <span class="n">qinfo</span><span class="p">,</span>
                                  <span class="n">para_info</span><span class="p">,</span> <span class="n">events</span><span class="p">]</span> <span class="o">+</span> <span class="n">task_info</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">task_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">),</span> <span class="n">qinfo</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span>
                                  <span class="n">para_info</span><span class="p">]</span> <span class="o">+</span> <span class="n">task_info</span><span class="p">)</span>

            <span class="c1"># Print table and write colorized line with the total number of errors.</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;grid&quot;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tot_num_errors</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Total number of errors: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tot_num_errors</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ok</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">all_ok reached</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.show_events"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_events">[docs]</a>    <span class="k">def</span> <span class="nf">show_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the Abinit events (ERRORS, WARNIING, COMMENTS) to stdout</span>

<span class="sd">        Args:</span>
<span class="sd">            status: if not None, only the tasks with this status are select</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">	&quot;&quot;&quot;</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">get_terminal_size</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">make_banner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span></div>
                <span class="c1">#report = report.filter_types()</span>

<div class="viewcode-block" id="Flow.show_corrections"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_corrections">[docs]</a>    <span class="k">def</span> <span class="nf">show_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the corrections applied to the flow at run-time.</span>

<span class="sd">        Args:</span>
<span class="sd">            status: if not None, only the tasks with this status are select.</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>

<span class="sd">        Return: The number of corrections found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">get_terminal_size</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">num_corrections</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">make_banner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">corrections</span><span class="p">:</span>
                <span class="n">pprint</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No correction found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="Flow.show_history"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_history">[docs]</a>    <span class="k">def</span> <span class="nf">show_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the history of the flow to stdout.</span>

<span class="sd">        Args:</span>
<span class="sd">            status: if not None, only the tasks with this status are select</span>
<span class="sd">            full_history: Print full info set, including nodes with an empty history.</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">            metadata: print history metadata (experimental)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">get_terminal_size</span><span class="p">()</span>

        <span class="n">works_done</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Loop on the tasks and show the history of the work is not in works_done</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">work</span>

            <span class="k">if</span> <span class="n">work</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">works_done</span><span class="p">:</span>
                <span class="n">works_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">work</span><span class="o">.</span><span class="n">history</span> <span class="ow">or</span> <span class="n">full_history</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="n">make_banner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">work</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">work</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">color_opts</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">history</span> <span class="ow">or</span> <span class="n">full_history</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="n">make_banner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">color_opts</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">))</span>

        <span class="c1"># Print the history of the flow.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="ow">or</span> <span class="n">full_history</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="n">make_banner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">color_opts</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">))</span></div>

<div class="viewcode-block" id="Flow.show_inputs"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">show_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the input of the tasks to the given stream.</span>

<span class="sd">        Args:</span>
<span class="sd">            varnames:</span>
<span class="sd">                List of Abinit variables. If not None, only the variable in varnames</span>
<span class="sd">                are selected and printed.</span>
<span class="sd">            nids:</span>
<span class="sd">                List of node identifiers. By defaults all nodes are shown</span>
<span class="sd">            wslice:</span>
<span class="sd">                Slice object used to select works.</span>
<span class="sd">            stream:</span>
<span class="sd">                File-like object, Default: sys.stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">varnames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Build dictionary varname --&gt; [(task1, value), (task2, value), ...]</span>
            <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">varnames</span><span class="p">)]</span>
            <span class="n">dlist</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="n">wslice</span><span class="p">):</span>
                <span class="n">dstruct</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;abivars&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># maybe in structure?</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">dstruct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dlist</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">task</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
                <span class="n">tv_list</span> <span class="o">=</span> <span class="n">dlist</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tv_list</span><span class="p">:</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]: Found 0 tasks with this variable</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]: Found </span><span class="si">%s</span><span class="s2"> tasks with this variable</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tv_list</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tv_list</span><span class="p">):</span>
                        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">task</span><span class="p">))</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="n">wslice</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">make_input</span><span class="p">(</span><span class="n">with_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Add info on dependencies.</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Dependencies:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Dependencies: None&quot;</span>

                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">*</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">stream</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.listext"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.listext">[docs]</a>    <span class="k">def</span> <span class="nf">listext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print to the given `stream` a table with the list of the output files</span>
<span class="sd">        with the given `ext` produced by the flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_nodes</span><span class="p">():</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filepath</span><span class="p">:</span>
                <span class="n">nodes_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">nodes_files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%s</span><span class="s2"> files with extension `</span><span class="si">%s</span><span class="s2">` produced by the flow&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes_files</span><span class="p">),</span> <span class="n">ext</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="p">[[</span><span class="n">f</span><span class="o">.</span><span class="n">relpath</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get_stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                      <span class="n">node</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">nodes_files</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;File&quot;</span><span class="p">,</span> <span class="s2">&quot;Size [Mb]&quot;</span><span class="p">,</span> <span class="s2">&quot;Node_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Node Class&quot;</span><span class="p">]),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output file with extension </span><span class="si">%s</span><span class="s2"> has been produced by the flow&quot;</span> <span class="o">%</span> <span class="n">ext</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.select_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.select_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">select_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list with a subset of tasks.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: List of node identifiers.</span>
<span class="sd">            wslice: Slice object used to select works.</span>
<span class="sd">            task_class: String or class used to select tasks. Ignored if None.</span>

<span class="sd">        .. note::</span>

<span class="sd">            nids and wslice are mutually exclusive.</span>
<span class="sd">            If no argument is provided, the full list of tasks is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">wslice</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_from_nids</span><span class="p">(</span><span class="n">nids</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">wslice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">wslice</span><span class="p">]:</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">work</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># All tasks selected if no option is provided.</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">())</span>

        <span class="c1"># Filter by task class</span>
        <span class="k">if</span> <span class="n">task_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isinstance</span><span class="p">(</span><span class="n">task_class</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">tasks</span></div>

<div class="viewcode-block" id="Flow.get_task_scfcycles"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.get_task_scfcycles">[docs]</a>    <span class="k">def</span> <span class="nf">get_task_scfcycles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_ok_tasks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of (taks, scfcycle) tuples for all the tasks in the flow with a SCF algorithm</span>
<span class="sd">        e.g. electronic GS-SCF iteration, DFPT-SCF iterations etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: List of node identifiers.</span>
<span class="sd">            wslice: Slice object used to select works.</span>
<span class="sd">            task_class: String or class used to select tasks. Ignored if None.</span>
<span class="sd">            exclude_ok_tasks: True if only running tasks should be considered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `ScfCycle` subclass instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">select_status</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">S_RUN</span><span class="p">]</span> <span class="k">if</span> <span class="n">exclude_ok_tasks</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">S_RUN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_OK</span><span class="p">]</span>
        <span class="n">tasks_cycles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="n">wslice</span><span class="p">):</span>
            <span class="c1"># Fileter</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">select_status</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">cycle_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">task_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">isinstance</span><span class="p">(</span><span class="n">task_class</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cycle</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">cycle_class</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cycle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tasks_cycles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">task</span><span class="p">,</span> <span class="n">cycle</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># This is intentionally ignored because from_file can fail for several reasons.</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">tasks_cycles</span></div>

<div class="viewcode-block" id="Flow.show_tricky_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_tricky_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">show_tricky_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print list of tricky tasks i.e. tasks that have been restarted or</span>
<span class="sd">        launched more than once or tasks with corrections.</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose: Verbosity level. If &gt; 0, task history and corrections (if any) are printed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nids</span><span class="p">,</span> <span class="n">tasks</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">num_launches</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">num_restarts</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">num_corrections</span><span class="p">)):</span>
                <span class="n">nids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">nids</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Everything&#39;s fine, no tricky tasks found&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_status</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use --verbose to print task history.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="o">**</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">color_opts</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_history</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="p">[</span><span class="n">nid</span><span class="p">],</span> <span class="n">full_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1">#if task.num_restarts:</span>
                <span class="c1">#    self.show_restarts(nids=[nid])</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">num_corrections</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">show_corrections</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="p">[</span><span class="n">nid</span><span class="p">])</span></div>

<div class="viewcode-block" id="Flow.inspect"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.inspect">[docs]</a>    <span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inspect the tasks (SCF iterations, Structural relaxation ...) and</span>
<span class="sd">        produces matplotlib plots.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: List of node identifiers.</span>
<span class="sd">            wslice: Slice object used to select works.</span>
<span class="sd">            kwargs: keyword arguments passed to `task.inspect` method.</span>

<span class="sd">        .. note::</span>

<span class="sd">            nids and wslice are mutually exclusive.</span>
<span class="sd">            If nids and wslice are both None, all tasks in self are inspected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `matplotlib` figures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">,</span> <span class="n">wslice</span><span class="o">=</span><span class="n">wslice</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;inspect&quot;</span><span class="p">):</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Cannot inspect Task </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Task </span><span class="si">%s</span><span class="s2"> does not provide an inspect method&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figs</span></div>

<div class="viewcode-block" id="Flow.get_results"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">from_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dict_for_mongodb_queries</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Flow.get_dict_for_mongodb_queries"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.get_dict_for_mongodb_queries">[docs]</a>    <span class="k">def</span> <span class="nf">get_dict_for_mongodb_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function returns a dictionary with the attributes that will be</span>
<span class="sd">        put in the mongodb document to facilitate the query.</span>
<span class="sd">        Subclasses may want to replace or extend the default behaviour.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">d</span>
        <span class="c1"># TODO</span>
        <span class="n">all_structures</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">structure</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">()]</span>
        <span class="n">all_pseudos</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">pseudos</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">()]</span></div>

<div class="viewcode-block" id="Flow.look_before_you_leap"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.look_before_you_leap">[docs]</a>    <span class="k">def</span> <span class="nf">look_before_you_leap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method should be called before running the calculation to make</span>
<span class="sd">        sure that the most important requirements are satisfied.</span>

<span class="sd">        Return:</span>
<span class="sd">            List of strings with inconsistencies/errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dependencies</span><span class="p">()</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_db</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">db_connector</span><span class="o">.</span><span class="n">get_collection</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    ERROR while trying to connect to the MongoDB database:</span>
<span class="s2">                        Exception:</span>
<span class="s2">                            </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                        Connector:</span>
<span class="s2">                            </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">db_connector</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if flow uses `MongoDB` to store the results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">has_db</span>

<div class="viewcode-block" id="Flow.db_insert"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.db_insert">[docs]</a>    <span class="k">def</span> <span class="nf">db_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert results in the `MongDB` database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_db</span>
        <span class="c1"># Connect to MongoDb and get the collection.</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">db_connector</span><span class="o">.</span><span class="n">get_collection</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mongodb collection </span><span class="si">%s</span><span class="s2"> with count </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">coll</span><span class="p">,</span> <span class="n">coll</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
                <span class="n">pprint</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">update_collection</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">update_collection</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MongoDb update done in </span><span class="si">%s</span><span class="s2"> [s]&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update_collection</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>

        <span class="c1"># Update the pickle file to save the mongo ids.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="p">():</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.tasks_from_nids"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.tasks_from_nids">[docs]</a>    <span class="k">def</span> <span class="nf">tasks_from_nids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of tasks associated to the given list of node identifiers (nids).</span>

<span class="sd">        .. note::</span>

<span class="sd">            Invalid ids are ignored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nids</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span> <span class="n">nids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nids</span><span class="p">]</span>

        <span class="n">n2task</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">node_id</span><span class="p">:</span> <span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">n2task</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nids</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n2task</span><span class="p">]</span></div>

<div class="viewcode-block" id="Flow.wti_from_nids"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.wti_from_nids">[docs]</a>    <span class="k">def</span> <span class="nf">wti_from_nids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of (w, t) indices from the list of node identifiers nids.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_from_nids</span><span class="p">(</span><span class="n">nids</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Flow.open_files"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.open_files">[docs]</a>    <span class="k">def</span> <span class="nf">open_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">editor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the files of the flow inside an editor (command line interface).</span>

<span class="sd">        Args:</span>
<span class="sd">            what: string with the list of characters selecting the file type</span>
<span class="sd">                  Possible choices:</span>
<span class="sd">                    i ==&gt; input_file,</span>
<span class="sd">                    o ==&gt; output_file,</span>
<span class="sd">                    f ==&gt; files_file,</span>
<span class="sd">                    j ==&gt; job_file,</span>
<span class="sd">                    l ==&gt; log_file,</span>
<span class="sd">                    e ==&gt; stderr_file,</span>
<span class="sd">                    q ==&gt; qout_file,</span>
<span class="sd">                    all ==&gt; all files.</span>
<span class="sd">            status: if not None, only the tasks with this status are select</span>
<span class="sd">            op: status operator. Requires status. A task is selected</span>
<span class="sd">                if task.status op status evaluates to true.</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">            editor: Select the editor. None to use the default editor ($EDITOR shell env var)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build list of files to analyze.</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">select_files</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lst</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Editor</span><span class="p">(</span><span class="n">editor</span><span class="o">=</span><span class="n">editor</span><span class="p">)</span><span class="o">.</span><span class="n">edit_files</span><span class="p">(</span><span class="n">files</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.parse_timing"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.parse_timing">[docs]</a>    <span class="k">def</span> <span class="nf">parse_timing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the timer data in the main output file(s) of Abinit.</span>
<span class="sd">        Requires timopt /= 0 in the input file (usually timopt = -1)</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>

<span class="sd">        Return: :class:`AbinitTimerParser` instance, None if error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the list of output files according to nids.</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">)]</span>

        <span class="c1"># Parse data.</span>
        <span class="kn">from</span> <span class="nn">.abitimer</span> <span class="k">import</span> <span class="n">AbinitTimerParser</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">AbinitTimerParser</span><span class="p">()</span>
        <span class="n">read_ok</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">read_ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parser</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Flow.show_abierrors"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_abierrors">[docs]</a>    <span class="k">def</span> <span class="nf">show_abierrors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write to the given stream the list of ABINIT errors for all tasks whose status is S_ABICRITICAL.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">            stream: File-like object. Default: sys.stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_ABICRITICAL</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;=== &quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;===&quot;</span>
            <span class="n">app</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;num_errors: </span><span class="si">%s</span><span class="s2">, num_warnings: </span><span class="si">%s</span><span class="s2">, num_comments: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">report</span><span class="o">.</span><span class="n">num_errors</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_warnings</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">num_comments</span><span class="p">))</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;*** ERRORS ***&quot;</span><span class="p">)</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;*** BUGS ***&quot;</span><span class="p">)</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">bugs</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;get_envent_report returned None!&quot;</span><span class="p">)</span>

            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.show_qouts"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_qouts">[docs]</a>    <span class="k">def</span> <span class="nf">show_qouts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write to the given stream the content of the queue output file for all tasks whose status is S_QCRITICAL.</span>

<span class="sd">        Args:</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">            stream: File-like object. Default: sys.stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_QCRITICAL</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;=== &quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;===&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">qout_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">+=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;File does not exist!&quot;</span><span class="p">)</span>

            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.debug"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.debug">[docs]</a>    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is usually used when the flow didn&#39;t completed succesfully</span>
<span class="sd">        It analyzes the files produced the tasks to facilitate debugging.</span>
<span class="sd">        Info are printed to stdout.</span>

<span class="sd">        Args:</span>
<span class="sd">            status: If not None, only the tasks with this status are selected</span>
<span class="sd">            nids: optional list of node identifiers used to filter the tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">get_terminal_size</span><span class="p">()</span>

        <span class="c1"># Test for scheduler exceptions first.</span>
        <span class="n">sched_excfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;_exceptions&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sched_excfile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sched_excfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Found exceptions raised by the scheduler&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">cprint</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_ERROR</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">))</span>
            <span class="n">qcriticals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_QCRITICAL</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">))</span>
            <span class="n">abicriticals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_ABICRITICAL</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">))</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">+</span> <span class="n">qcriticals</span> <span class="o">+</span> <span class="n">abicriticals</span>

        <span class="c1"># For each task selected:</span>
        <span class="c1">#     1) Check the error files of the task. If not empty, print the content to stdout and we are done.</span>
        <span class="c1">#     2) If error files are empty, look at the master log file for possible errors</span>
        <span class="c1">#     3) If also this check failes, scan all the process log files.</span>
        <span class="c1">#        TODO: This check is not needed if we introduce a new __abinit_error__ file</span>
        <span class="c1">#        that is created by the first MPI process that invokes MPI abort!</span>
        <span class="c1">#</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">make_banner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="n">ntasks</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#  Start with error files.</span>
            <span class="k">for</span> <span class="n">efname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;qerr_file&quot;</span><span class="p">,</span> <span class="s2">&quot;stderr_file&quot;</span><span class="p">,]:</span>
                <span class="n">err_file</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">efname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">err_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">make_banner</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err_file</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                    <span class="c1">#count += 1</span>

            <span class="c1"># Check main log file.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">report</span> <span class="ow">and</span> <span class="n">report</span><span class="o">.</span><span class="n">num_errors</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">make_banner</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="s2">&quot;=&quot;</span><span class="p">))</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># count &gt; 0 means we found some useful info that could explain the failures.</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
                <span class="c1"># Inspect all log files produced by the other nodes.</span>
                <span class="n">log_files</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">list_filepaths</span><span class="p">(</span><span class="n">wildcard</span><span class="o">=</span><span class="s2">&quot;*LOG_*&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">log_files</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;No *LOG_* file in tmpdir. This usually happens if you are running with many CPUs&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">log_file</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">report</span> <span class="o">=</span> <span class="n">EventsParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
                            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">cprint</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Houston, we could not find any error message that can explain the problem&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of tasks analyzed: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ntasks</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.cancel"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancel all the tasks that are in the queue.</span>
<span class="sd">        nids is an optional list of node identifiers used to filter the tasks.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of jobs cancelled, negative value if error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_chrooted</span><span class="p">:</span>
            <span class="c1"># TODO: Use paramiko to kill the job?</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot cancel the flow via sshfs!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># If we are running with the scheduler, we must send a SIGKILL signal.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid_file</span><span class="p">):</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Found scheduler attached to this flow.&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s2">&quot;Sending SIGKILL to the scheduler before cancelling the tasks!&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid_file</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

            <span class="n">retcode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;kill -9 </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sent SIGKILL to the scheduler, retcode: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">retcode</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">num_cancelled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">nids</span><span class="o">=</span><span class="n">nids</span><span class="p">):</span>
            <span class="n">num_cancelled</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">num_cancelled</span></div>

<div class="viewcode-block" id="Flow.get_njobs_in_queue"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.get_njobs_in_queue">[docs]</a>    <span class="k">def</span> <span class="nf">get_njobs_in_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the number of jobs in the queue, None when the number of jobs cannot be determined.</span>

<span class="sd">        Args:</span>
<span class="sd">            username: (str) the username of the jobs to count (default is to autodetect)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">qadapter</span><span class="o">.</span><span class="n">get_njobs_in_queue</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.rmtree"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.rmtree">[docs]</a>    <span class="k">def</span> <span class="nf">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove workdir (same API as shutil.rmtree).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span> <span class="k">return</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="n">ignore_errors</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">onerror</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.rm_and_build"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.rm_and_build">[docs]</a>    <span class="k">def</span> <span class="nf">rm_and_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the workdir and rebuild the flow.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmtree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span></div>

<div class="viewcode-block" id="Flow.build"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make directories and files of the `Flow`.&quot;&quot;&quot;</span>
        <span class="c1"># Allocate here if not done yet!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>

        <span class="c1"># Check the nodeid file in workdir</span>
        <span class="n">nodeid_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;.nodeid&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">nodeid_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">nodeid_path</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">node_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span> <span class="o">!=</span> <span class="n">node_id</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found node_id </span><span class="si">%s</span><span class="s2"> in file:</span><span class="se">\n\n</span><span class="s2">  </span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">while the node_id of the present flow is </span><span class="si">%d</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;This means that you are trying to build a new flow in a directory already used by another flow.</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;Possible solutions:</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;   1) Change the workdir of the new flow.</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="s2">&quot;   2) remove the old directory either with `rm -r` or by calling the method flow.rmtree()</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">nodeid_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">nodeid_path</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyfile</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pyfile</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pyfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.build_and_pickle_dump"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.build_and_pickle_dump">[docs]</a>    <span class="k">def</span> <span class="nf">build_and_pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abivalidate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build dirs and file of the `Flow` and save the object in pickle format.</span>
<span class="sd">        Returns 0 if success</span>

<span class="sd">        Args:</span>
<span class="sd">            abivalidate: If True, all the input files are validate by calling</span>
<span class="sd">                the abinit parser. If the validation fails, ValueError is raise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abivalidate</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>

        <span class="c1"># Validation with Abinit.</span>
        <span class="n">isok</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abivalidate_inputs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isok</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span>
        <span class="n">errlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
            <span class="n">errlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errlines</span><span class="p">))</span></div>

<div class="viewcode-block" id="Flow.pickle_dump"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.pickle_dump">[docs]</a>    <span class="nd">@check_spectator</span>
    <span class="k">def</span> <span class="nf">pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the status of the object in pickle format.</span>
<span class="sd">        Returns 0 if success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_chrooted</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot pickle_dump since we have chrooted from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_chrooted</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1">#if self.in_spectator_mode:</span>
        <span class="c1">#    warnings.warn(&quot;Cannot pickle_dump since flow is in_spectator_mode&quot;)</span>
        <span class="c1">#    return -2</span>

        <span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle_protocol</span>

        <span class="c1"># Atomic transaction with FileLock.</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">AtomicFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">pmg_pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Flow.pickle_dumps"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.pickle_dumps">[docs]</a>    <span class="k">def</span> <span class="nf">pickle_dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string with the pickle representation.</span>
<span class="sd">        `protocol` selects the pickle protocol. self.pickle_protocol is</span>
<span class="sd">         used if `protocol` is None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">pmg_pickle_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strio</span><span class="p">,</span>
                        <span class="n">protocol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle_protocol</span> <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="n">protocol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">strio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>

<div class="viewcode-block" id="Flow.register_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.register_task">[docs]</a>    <span class="k">def</span> <span class="nf">register_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility function that generates a `Work` made of a single task</span>

<span class="sd">        Args:</span>
<span class="sd">            input: :class:`AbinitInput`</span>
<span class="sd">            deps: List of :class:`Dependency` objects specifying the dependency of this node.</span>
<span class="sd">                  An empy list of deps implies that this node has no dependencies.</span>
<span class="sd">            manager: The :class:`TaskManager` responsible for the submission of the task.</span>
<span class="sd">                     If manager is None, we use the :class:`TaskManager` specified during the creation of the work.</span>
<span class="sd">            task_class: Task subclass to instantiate. Default: :class:`AbinitTask`</span>
<span class="sd">            append: If true, the task is added to the last work (a new Work is created if flow is empty)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The generated :class:`Work` for the task, work[0] is the actual task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># append True is much easier to use. In principle should be the default behaviour</span>
        <span class="c1"># but this would break the previous API so ...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">append</span><span class="p">:</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">Work</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">:</span>
                <span class="n">work</span> <span class="o">=</span> <span class="n">Work</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
                <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">task_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">append</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span></div>

<div class="viewcode-block" id="Flow.register_work"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.register_work">[docs]</a>    <span class="k">def</span> <span class="nf">register_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new :class:`Work` and add it to the internal list, taking into account possible dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            work: :class:`Work` object.</span>
<span class="sd">            deps: List of :class:`Dependency` objects specifying the dependency of this node.</span>
<span class="sd">                  An empy list of deps implies that this node has no dependencies.</span>
<span class="sd">            manager: The :class:`TaskManager` responsible for the submission of the task.</span>
<span class="sd">                     If manager is None, we use the `TaskManager` specified during the creation of the work.</span>
<span class="sd">            workdir: The name of the directory used for the :class:`Work`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The registered :class:`Work`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;workdir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># The flow has a directory, build the named of the directory of the work.</span>
            <span class="n">work_workdir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">workdir</span><span class="p">))</span>

            <span class="n">work</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">work_workdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">works</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dependency</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">exts</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span></div>

<div class="viewcode-block" id="Flow.register_work_from_cbk"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.register_work_from_cbk">[docs]</a>    <span class="k">def</span> <span class="nf">register_work_from_cbk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbk_name</span><span class="p">,</span> <span class="n">cbk_data</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">work_class</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a callback function that will generate the :class:`Task` of the :class:`Work`.</span>

<span class="sd">        Args:</span>
<span class="sd">            cbk_name: Name of the callback function (must be a bound method of self)</span>
<span class="sd">            cbk_data: Additional data passed to the callback function.</span>
<span class="sd">            deps: List of :class:`Dependency` objects specifying the dependency of the work.</span>
<span class="sd">            work_class: :class:`Work` class to instantiate.</span>
<span class="sd">            manager: The :class:`TaskManager` responsible for the submission of the task.</span>
<span class="sd">                    If manager is None, we use the `TaskManager` specified during the creation of the :class:`Flow`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The :class:`Work` that will be finalized by the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: pass a Work factory instead of a class</span>
        <span class="c1"># Directory of the Work.</span>
        <span class="n">work_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

        <span class="c1"># Create an empty work and register the callback</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">work_class</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">work_workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_works</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dependency</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">exts</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A callback must have deps!&quot;</span><span class="p">)</span>

        <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="c1"># Wrap the callable in a Callback object and save</span>
        <span class="c1"># useful info such as the index of the work and the callback data.</span>
        <span class="n">cbk</span> <span class="o">=</span> <span class="n">FlowCallback</span><span class="p">(</span><span class="n">cbk_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">cbk_data</span><span class="o">=</span><span class="n">cbk_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">work</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Numer of allocations. Set by `allocate`.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocated</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="Flow.allocate"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.allocate">[docs]</a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_smartio</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocate the `Flow` i.e. assign the `workdir` and (optionally)</span>
<span class="sd">        the :class:`TaskManager` to the different tasks in the Flow.</span>

<span class="sd">        Args:</span>
<span class="sd">            workdir: Working directory of the flow. Must be specified here</span>
<span class="sd">                if we haven&#39;t initialized the workdir in the __init__.</span>

<span class="sd">        Return:</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We set the workdir of the flow here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">work</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">work</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;workdir&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You must call flow.allocate(workdir) if the workdir is not passed to __init__&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># Each work has a reference to its flow.</span>
            <span class="n">work</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>
            <span class="n">work</span><span class="o">.</span><span class="n">set_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1"># Each task has a reference to its work.</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">set_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_dependencies</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_allocated&quot;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allocated</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">use_smartio</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_smartio</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Flow.use_smartio"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.use_smartio">[docs]</a>    <span class="k">def</span> <span class="nf">use_smartio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function should be called when the entire `Flow` has been built.</span>
<span class="sd">        It tries to reduce the pressure on the hard disk by using Abinit smart-io</span>
<span class="sd">        capabilities for those files that are not needed by other nodes.</span>
<span class="sd">        Smart-io means that big files (e.g. WFK) are written only if the calculation</span>
<span class="sd">        is unconverged so that we can restart from it. No output is produced if</span>
<span class="sd">        convergence is achieved.</span>

<span class="sd">        Return:</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">:</span>
            <span class="c1">#raise RuntimeError(&quot;You must call flow.allocate() before invoking flow.use_smartio()&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">children</span><span class="p">:</span>
                <span class="c1"># Change the input so that output files are produced</span>
                <span class="c1"># only if the calculation is not converged.</span>
                <span class="n">task</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will disable IO for task&quot;</span><span class="p">)</span>
                <span class="n">task</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">prtden</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># TODO: prt1wf=-1,</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">must_produce_abiexts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                    <span class="c1"># Get the list of dependencies. Find that task</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                        <span class="n">must_produce_abiexts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">exts</span><span class="p">)</span>

                <span class="n">must_produce_abiexts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">must_produce_abiexts</span><span class="p">)</span>
                <span class="c1">#print(&quot;must_produce_abiexts&quot;, must_produce_abiexts)</span>

                <span class="c1"># Variables supporting smart-io.</span>
                <span class="n">smart_prtvars</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;prtwf&quot;</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># Set the variable to -1 to disable the output</span>
                <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">abiext</span> <span class="ow">in</span> <span class="n">smart_prtvars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">abiext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">must_produce_abiexts</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: setting </span><span class="si">%s</span><span class="s2"> to -1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">varname</span><span class="p">))</span>
                        <span class="n">task</span><span class="o">.</span><span class="n">set_vars</span><span class="p">({</span><span class="n">varname</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1">#def new_from_input_decorators(self, new_workdir, decorators)</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Return a new :class:`Flow` in which all the Abinit inputs have been</span>
    <span class="c1">#    decorated by decorators.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    # The trick part here is how to assign a new id to the new nodes while maintaing the</span>
    <span class="c1">#    # correct dependencies! The safest approach would be to pass through __init__</span>
    <span class="c1">#    # instead of using copy.deepcopy()</span>
    <span class="c1">#    return flow</span>

<div class="viewcode-block" id="Flow.show_dependencies"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">show_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes to the given stream the ASCII representation of the dependency tree.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">child_iter</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">text_str</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">colored</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">color_opts</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">draw_tree</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">child_iter</span><span class="p">,</span> <span class="n">text_str</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.on_dep_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.on_dep_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_dep_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="c1"># Replace this callback with dynamic dispatch</span>
        <span class="c1"># on_all_S_OK for work</span>
        <span class="c1"># on_S_OK for task</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;on_dep_ok with sender </span><span class="si">%s</span><span class="s2">, signal </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sender</span><span class="p">),</span> <span class="n">signal</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cbk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbk</span><span class="o">.</span><span class="n">handle_sender</span><span class="p">(</span><span class="n">sender</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not handle sender </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cbk</span><span class="p">,</span> <span class="n">sender</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbk</span><span class="o">.</span><span class="n">can_execute</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cannot execute </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cbk</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Execute the callback and disable it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;flow in on_dep_ok: about to execute callback </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">cbk</span><span class="p">))</span>
            <span class="n">cbk</span><span class="p">()</span>
            <span class="n">cbk</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

            <span class="c1"># Update the database.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pickle_dump</span><span class="p">()</span></div>

<div class="viewcode-block" id="Flow.finalize"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.finalize">[docs]</a>    <span class="nd">@check_spectator</span>
    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when the flow is completed.</span>
<span class="sd">        Return 0 if success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Calling finalize on an already finalized flow.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calling flow.finalize.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving results in database.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">db_insert</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;MongoDb insertion failed.&quot;</span><span class="p">)</span>
                 <span class="k">return</span> <span class="mi">2</span>

        <span class="c1"># Here we remove the big output files if we have the garbage collector</span>
        <span class="c1"># and the policy is set to &quot;flow.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">policy</span> <span class="o">==</span> <span class="s2">&quot;flow&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;gc.policy set to flow. Will clean task output files.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
                <span class="n">task</span><span class="o">.</span><span class="n">clean_output_files</span><span class="p">()</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Flow.set_garbage_collector"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.set_garbage_collector">[docs]</a>    <span class="k">def</span> <span class="nf">set_garbage_collector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="s2">&quot;task&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable the garbage collector that will remove the big output files that are not needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            exts: string or list with the Abinit file extensions to be removed. A default is</span>
<span class="sd">                provided if exts is None</span>
<span class="sd">            policy: Either `flow` or `task`. If policy is set to &#39;task&#39;, we remove the output</span>
<span class="sd">                files as soon as the task reaches S_OK. If &#39;flow&#39;, the files are removed</span>
<span class="sd">                only when the flow is finalized. This option should be used when we are dealing</span>
<span class="sd">                with a dynamic flow with callbacks generating other tasks since a :class:`Task`</span>
<span class="sd">                might not be aware of its children when it reached S_OK.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">policy</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="s2">&quot;flow&quot;</span><span class="p">)</span>
        <span class="n">exts</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">exts</span><span class="p">)</span> <span class="k">if</span> <span class="n">exts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;SUS&quot;</span><span class="p">,</span> <span class="s2">&quot;SCR&quot;</span><span class="p">,</span> <span class="s2">&quot;BSR&quot;</span><span class="p">,</span> <span class="s2">&quot;BSC&quot;</span><span class="p">)</span>

        <span class="n">gc</span> <span class="o">=</span> <span class="n">GarbageCollector</span><span class="p">(</span><span class="n">exts</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">exts</span><span class="p">),</span> <span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_gc</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1">#work.set_gc(gc) # TODO Add support for Works and flow policy</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">set_gc</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.connect_signals"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.connect_signals">[docs]</a>    <span class="k">def</span> <span class="nf">connect_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect the signals within the `Flow`.</span>
<span class="sd">        The `Flow` is responsible for catching the important signals raised from its works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Connect the signals inside each Work.</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>

        <span class="c1"># Observe the nodes that must reach S_OK in order to call the callbacks.</span>
        <span class="k">for</span> <span class="n">cbk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="c1">#cbk.enable()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">cbk</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;connecting </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">with sender </span><span class="si">%s</span><span class="s2">, signal </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cbk</span><span class="p">),</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span><span class="p">))</span>
                <span class="n">dispatcher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_dep_ok</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

        <span class="c1"># Associate to each signal the callback _on_signal</span>
        <span class="c1"># (bound method of the node that will be called by `Flow`</span>
        <span class="c1"># Each node will set its attribute _done_signal to True to tell</span>
        <span class="c1"># the flow that this callback should be disabled.</span>

        <span class="c1"># Register the callbacks for the Work.</span>
        <span class="c1">#for work in self:</span>
        <span class="c1">#    slot = self._sig_slots[work]</span>
        <span class="c1">#    for signal in S_ALL:</span>
        <span class="c1">#        done_signal = getattr(work, &quot;_done_ &quot; + signal, False)</span>
        <span class="c1">#        if not done_sig:</span>
        <span class="c1">#            cbk_name = &quot;_on_&quot; + str(signal)</span>
        <span class="c1">#            cbk = getattr(work, cbk_name, None)</span>
        <span class="c1">#            if cbk is None: continue</span>
        <span class="c1">#            slot[work][signal].append(cbk)</span>
        <span class="c1">#            print(&quot;connecting %s\nwith sender %s, signal %s&quot; % (str(cbk), dep.node, dep.node.S_OK))</span>
        <span class="c1">#            dispatcher.connect(self.on_dep_ok, signal=signal, sender=dep.node, weak=False)</span>

        <span class="c1"># Register the callbacks for the Tasks.</span>
        <span class="c1">#self.show_receivers()</span>

<div class="viewcode-block" id="Flow.disconnect_signals"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.disconnect_signals">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disable the signals within the `Flow`.&quot;&quot;&quot;</span>
        <span class="c1"># Disconnect the signals inside each Work.</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">disconnect_signals</span><span class="p">()</span>

        <span class="c1"># Disable callbacks.</span>
        <span class="k">for</span> <span class="n">cbk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="n">cbk</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span></div>

<div class="viewcode-block" id="Flow.show_receivers"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.show_receivers">[docs]</a>    <span class="k">def</span> <span class="nf">show_receivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="n">sender</span> <span class="k">if</span> <span class="n">sender</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">Any</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span> <span class="k">if</span> <span class="n">signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">Any</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** live receivers ***&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">liveReceivers</span><span class="p">(</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">getReceivers</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">signal</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;receiver --&gt;&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** end live receivers ***&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.set_spectator_mode"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.set_spectator_mode">[docs]</a>    <span class="k">def</span> <span class="nf">set_spectator_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When the flow is in spectator_mode, we have to disable signals, pickle dump and possible callbacks</span>
<span class="sd">        A spectator can still operate on the flow but the new status of the flow won&#39;t be saved in</span>
<span class="sd">        the pickle file. Usually the flow is in spectator mode when we are already running it via</span>
<span class="sd">        the scheduler or other means and we should not interfere with its evolution.</span>
<span class="sd">        This is the reason why signals and callbacks must be disabled.</span>
<span class="sd">        Unfortunately preventing client-code from calling methods with side-effects when</span>
<span class="sd">        the flow is in spectator mode is not easy (e.g. flow.cancel will cancel the tasks submitted to the</span>
<span class="sd">        queue and the flow used by the scheduler won&#39;t see this change!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set the flags of all the nodes in the flow.</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_spectator_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_nodes</span><span class="p">():</span>
            <span class="n">node</span><span class="o">.</span><span class="n">in_spectator_mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="c1"># connect/disconnect signals depending on mode.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_signals</span><span class="p">()</span></div>

    <span class="c1">#def get_results(self, **kwargs)</span>

<div class="viewcode-block" id="Flow.rapidfire"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.rapidfire">[docs]</a>    <span class="k">def</span> <span class="nf">rapidfire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_nlaunch</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_loops</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use :class:`PyLauncher` to submits tasks in rapidfire mode.</span>
<span class="sd">        kwargs contains the options passed to the launcher.</span>

<span class="sd">        Args:</span>
<span class="sd">            check_status:</span>
<span class="sd">            max_nlaunch: Maximum number of launches. default: no limit.</span>
<span class="sd">            max_loops: Maximum number of loops</span>
<span class="sd">            sleep_time: seconds to sleep between rapidfire loop iterations</span>

<span class="sd">        Return:</span>
<span class="sd">            Number of tasks submitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_pid_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_spectator_mode</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_status</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">.launcher</span> <span class="k">import</span> <span class="n">PyLauncher</span>
        <span class="k">return</span> <span class="n">PyLauncher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">rapidfire</span><span class="p">(</span><span class="n">max_nlaunch</span><span class="o">=</span><span class="n">max_nlaunch</span><span class="p">,</span> <span class="n">max_loops</span><span class="o">=</span><span class="n">max_loops</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">sleep_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.single_shot"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.single_shot">[docs]</a>    <span class="k">def</span> <span class="nf">single_shot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use :class:`PyLauncher` to submits one task.</span>
<span class="sd">        kwargs contains the options passed to the launcher.</span>

<span class="sd">        Return:</span>
<span class="sd">            number of tasks submitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_pid_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_spectator_mode</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_status</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">.launcher</span> <span class="k">import</span> <span class="n">PyLauncher</span>
        <span class="k">return</span> <span class="n">PyLauncher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">single_shot</span><span class="p">()</span></div>

<div class="viewcode-block" id="Flow.make_scheduler"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.make_scheduler">[docs]</a>    <span class="k">def</span> <span class="nf">make_scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a return a :class:`PyFlowScheduler` to run the flow.</span>

<span class="sd">        Args:</span>
<span class="sd">            kwargs: if empty we use the user configuration file.</span>
<span class="sd">                    if `filepath` in kwargs we init the scheduler from filepath.</span>
<span class="sd">                    else pass **kwargs to :class:`PyFlowScheduler` __init__ method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.launcher</span> <span class="k">import</span> <span class="n">PyFlowScheduler</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># User config if kwargs is empty</span>
            <span class="n">sched</span> <span class="o">=</span> <span class="n">PyFlowScheduler</span><span class="o">.</span><span class="n">from_user_config</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use from_file if filepath if present, else call __init__</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filepath&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwargs</span>
                <span class="n">sched</span> <span class="o">=</span> <span class="n">PyFlowScheduler</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sched</span> <span class="o">=</span> <span class="n">PyFlowScheduler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">sched</span><span class="o">.</span><span class="n">add_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sched</span></div>

<div class="viewcode-block" id="Flow.batch"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.batch">[docs]</a>    <span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timelimit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the flow in batch mode, return exit status of the job script.</span>
<span class="sd">        Requires a manager.yml file and a batch_adapter adapter.</span>

<span class="sd">        Args:</span>
<span class="sd">            timelimit: Time limit (int with seconds or string with time given with the slurm convention:</span>
<span class="sd">            &quot;days-hours:minutes:seconds&quot;). If timelimit is None, the default value specified in the</span>
<span class="sd">            `batch_adapter` entry of `manager.yml` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.launcher</span> <span class="k">import</span> <span class="n">BatchLauncher</span>
        <span class="c1"># Create a batch dir from the flow.workdir.</span>
        <span class="n">prev_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">prev_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">prev_dir</span><span class="p">)</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prev_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_batch&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">BatchLauncher</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">flows</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">timelimit</span><span class="o">=</span><span class="n">timelimit</span><span class="p">)</span></div>

<div class="viewcode-block" id="Flow.make_light_tarfile"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.make_light_tarfile">[docs]</a>    <span class="k">def</span> <span class="nf">make_light_tarfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lightweight tarball file. Mainly used for debugging. Return the name of the tarball file.&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-light.tar.gz&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_tarfile</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">exclude_dirs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;outdata&quot;</span><span class="p">,</span> <span class="s2">&quot;indata&quot;</span><span class="p">,</span> <span class="s2">&quot;tmpdata&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Flow.make_tarfile"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.make_tarfile">[docs]</a>    <span class="k">def</span> <span class="nf">make_tarfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_filesize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_exts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_dirs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a tarball file.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the tarball file. Set to os.path.basename(`flow.workdir`) + &quot;tar.gz&quot;` if name is None.</span>
<span class="sd">            max_filesize (int or string with unit): a file is included in the tar file if its size &lt;= max_filesize</span>
<span class="sd">                Can be specified in bytes e.g. `max_files=1024` or with a string with unit e.g. `max_filesize=&quot;1 Mb&quot;`.</span>
<span class="sd">                No check is done if max_filesize is None.</span>
<span class="sd">            exclude_exts: List of file extensions to be excluded from the tar file.</span>
<span class="sd">            exclude_dirs: List of directory basenames to be excluded.</span>
<span class="sd">            verbose (int): Verbosity level.</span>
<span class="sd">            kwargs: keyword arguments passed to the :class:`TarFile` constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The name of the tarfile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">any2bytes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Convert string or number to memory in bytes.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">Memory</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_filesize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_filesize</span> <span class="o">=</span> <span class="n">any2bytes</span><span class="p">(</span><span class="n">max_filesize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exclude_exts</span><span class="p">:</span>
            <span class="c1"># Add/remove &quot;.nc&quot; so that we can simply pass &quot;GSR&quot; instead of &quot;GSR.nc&quot;</span>
            <span class="c1"># Moreover this trick allows one to treat WFK.nc and WFK file on the same footing.</span>
            <span class="n">exts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">exclude_exts</span><span class="p">):</span>
                <span class="n">exts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">):</span>
                    <span class="n">exts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span><span class="p">)</span>
            <span class="n">exclude_exts</span> <span class="o">=</span> <span class="n">exts</span>

        <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">tarinfo</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Function that takes a TarInfo object argument and returns the changed TarInfo object.</span>
<span class="sd">            If it instead returns None the TarInfo object will be excluded from the archive.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Skip links.</span>
            <span class="k">if</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">issym</span><span class="p">()</span> <span class="ow">or</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">islnk</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excluding link: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Check size in bytes</span>
            <span class="k">if</span> <span class="n">max_filesize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_filesize</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excluding </span><span class="si">%s</span><span class="s2"> due to max_filesize&quot;</span> <span class="o">%</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Filter filenames.</span>
            <span class="k">if</span> <span class="n">exclude_exts</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">exclude_exts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excluding </span><span class="si">%s</span><span class="s2"> due to extension&quot;</span> <span class="o">%</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Exlude directories (use dir basenames).</span>
            <span class="k">if</span> <span class="n">exclude_dirs</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">dir_name</span> <span class="ow">in</span> <span class="n">exclude_dirs</span> <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excluding </span><span class="si">%s</span><span class="s2"> due to exclude_dirs&quot;</span> <span class="o">%</span> <span class="n">tarinfo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">tarinfo</span>

        <span class="n">back</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">))</span>

        <span class="kn">import</span> <span class="nn">tarfile</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.tar.gz&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w:gz&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">),</span> <span class="n">arcname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>

            <span class="c1"># Add the script used to generate the flow.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pyfile</span><span class="p">):</span>
                <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pyfile</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">back</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span></div>

    <span class="c1">#def abirobot(self, ext, check_status=True, nids=None):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Builds and return the :class:`Robot` subclass from the file extension `ext`.</span>
    <span class="c1">#    `nids` is an optional list of node identifiers used to filter the tasks in the flow.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    from abipy.abilab import abirobot</span>
    <span class="c1">#    if check_status: self.check_status()</span>
    <span class="c1">#    return abirobot(flow=self, ext=ext, nids=nids):</span>

<div class="viewcode-block" id="Flow.get_graphviz"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.get_graphviz">[docs]</a>    <span class="k">def</span> <span class="nf">get_graphviz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="n">graph_attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">node_attr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_attr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate flow graph in the DOT language.</span>

<span class="sd">        Args:</span>
<span class="sd">            engine: Layout command used. [&#39;dot&#39;, &#39;neato&#39;, &#39;twopi&#39;, &#39;circo&#39;, &#39;fdp&#39;, &#39;sfdp&#39;, &#39;patchwork&#39;, &#39;osage&#39;]</span>
<span class="sd">            graph_attr: Mapping of (attribute, value) pairs for the graph.</span>
<span class="sd">            node_attr: Mapping of (attribute, value) pairs set for all nodes.</span>
<span class="sd">            edge_attr: Mapping of (attribute, value) pairs set for all edges.</span>

<span class="sd">        Returns: graphviz.Digraph &lt;https://graphviz.readthedocs.io/en/stable/api.html#digraph&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">graphviz</span> <span class="k">import</span> <span class="n">Digraph</span>
        <span class="n">fg</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="s2">&quot;flow&quot;</span><span class="p">,</span> <span class="c1">#filename=&quot;flow_%s.gv&quot; % os.path.basename(self.relworkdir),</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;fdp&quot;</span> <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;automatic&quot;</span> <span class="k">else</span> <span class="n">engine</span><span class="p">)</span>

        <span class="c1"># Set graph attributes.</span>
        <span class="c1"># https://www.graphviz.org/doc/info/</span>
        <span class="c1">#fg.attr(label=&quot;%s@%s&quot; % (self.__class__.__name__, self.relworkdir))</span>
        <span class="n">fg</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="c1">#fg.attr(fontcolor=&quot;white&quot;, bgcolor=&#39;purple:pink&#39;)</span>
        <span class="n">fg</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="n">pagedir</span><span class="o">=</span><span class="s2">&quot;BL&quot;</span><span class="p">)</span>
        <span class="c1">#fg.attr(constraint=&quot;false&quot;, pack=&quot;true&quot;, packMode=&quot;clust&quot;)</span>
        <span class="n">fg</span><span class="o">.</span><span class="n">node_attr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue2&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;filled&#39;</span><span class="p">)</span>
        <span class="c1">#fg.node_attr.update(ranksep=&#39;equally&#39;)</span>

        <span class="c1"># Add input attributes.</span>
        <span class="k">if</span> <span class="n">graph_attr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fg</span><span class="o">.</span><span class="n">graph_attr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">graph_attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_attr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fg</span><span class="o">.</span><span class="n">node_attr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">node_attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">edge_attr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fg</span><span class="o">.</span><span class="n">edge_attr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">edge_attr</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">node_kwargs</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="c1">#shape=&quot;circle&quot;,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">color_hex</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;8.0&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;pos_str&quot;</span><span class="p">)</span> <span class="k">else</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">pos_str</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">edge_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arrowType</span><span class="o">=</span><span class="s2">&quot;vee&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>
        <span class="n">cluster_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="n">pagedir</span><span class="o">=</span><span class="s2">&quot;BL&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;rounded&quot;</span><span class="p">,</span> <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;azure2&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># Build cluster with tasks.</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="s2">&quot;cluster</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">work</span><span class="o">.</span><span class="n">name</span>
            <span class="k">with</span> <span class="n">fg</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cluster_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">wg</span><span class="p">:</span>
                <span class="n">wg</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="o">**</span><span class="n">cluster_kwargs</span><span class="p">)</span>
                <span class="n">wg</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">work</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="c1">#wg.attr(label=repr(work))</span>
                <span class="c1">#wg.attr(label=&quot;%s (%s)\n%s (%s)&quot; % (</span>
                <span class="c1">#    work.__class__.__name__, work.name, work.relworkdir, work.node_id))</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                    <span class="n">wg</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">node_kwargs</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
                    <span class="c1"># Connect children to task.</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
                        <span class="c1"># Find file extensions required by this task</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                        <span class="n">edge_label</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">exts</span><span class="p">)</span>
                        <span class="n">fg</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">edge_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">color_hex</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">edge_kwargs</span><span class="p">)</span>

        <span class="c1"># Treat the case in which we have a work producing output for other tasks.</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">children</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">cluster_name</span> <span class="o">=</span> <span class="s2">&quot;cluster</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">work</span><span class="o">.</span><span class="n">name</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="c1"># This is not needed, too much confusing</span>
                <span class="c1">#fg.edge(cluster_name, child.name, color=work.color_hex, **edge_kwargs)</span>
                <span class="c1"># Find file extensions required by work</span>
                <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">exts</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">fg</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="n">fg</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">edge_kwargs</span><span class="p">)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">fg</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">work</span><span class="o">.</span><span class="n">color_hex</span><span class="p">,</span> <span class="o">**</span><span class="n">edge_kwargs</span><span class="p">)</span>

        <span class="c1"># Treat the case in which we have a task that depends on external files.</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="c1">#print(task.get_parents())</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">get_parents</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">):</span>
                <span class="c1">#print(&quot;parent file node&quot;, node)</span>
                <span class="c1">#infile = &quot;%s (%s)&quot; % (ext, work.name)</span>
                <span class="n">infile</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">filepath</span>
                <span class="k">if</span> <span class="n">infile</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
                    <span class="n">fg</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="o">**</span><span class="n">node_kwargs</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>

                <span class="n">fg</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">color_hex</span><span class="p">,</span> <span class="o">**</span><span class="n">edge_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fg</span></div>

<div class="viewcode-block" id="Flow.graphviz_imshow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.graphviz_imshow">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">graphviz_imshow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate flow graph in the DOT language and plot it with matplotlib.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            figsize: matplotlib figure size (None to use default)</span>
<span class="sd">            dpi: DPI value.</span>
<span class="sd">            fmt: Select format for output image</span>

<span class="sd">        Return: matplotlib Figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_graphviz</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dpi</span><span class="p">))</span>
        <span class="c1">#print(graph)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">tmpname</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">tmpname</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">))</span> <span class="c1">#, interpolation=&quot;none&quot;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Flow.plot_networkx"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.Flow.plot_networkx">[docs]</a>    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_networkx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="n">with_edge_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arrows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">node_size</span><span class="o">=</span><span class="s2">&quot;num_cores&quot;</span><span class="p">,</span> <span class="n">node_label</span><span class="o">=</span><span class="s2">&quot;name_class&quot;</span><span class="p">,</span> <span class="n">layout_type</span><span class="o">=</span><span class="s2">&quot;spring&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use networkx to draw the flow with the connections among the nodes and</span>
<span class="sd">        the status of the tasks.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode: `networkx` to show connections, `status` to group tasks by status.</span>
<span class="sd">            with_edge_labels: True to draw edge labels.</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>
<span class="sd">            arrows: if True draw arrowheads.</span>
<span class="sd">            node_size: By default, the size of the node is proportional to the number of cores used.</span>
<span class="sd">            node_label: By default, the task class is used to label node.</span>
<span class="sd">            layout_type: Get positions for all nodes using `layout_type`. e.g. pos = nx.spring_layout(g)</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Requires networkx package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

        <span class="c1"># Build the graph</span>
        <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">arrows</span> <span class="k">else</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="n">edge_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                <span class="c1"># TODO: Add getters! What about locked nodes!</span>
                <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="n">edge_labels</span><span class="p">[(</span><span class="n">task</span><span class="p">,</span> <span class="n">child</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">exts</span><span class="p">)</span>

            <span class="n">filedeps</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">deps</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">is_file</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">filedeps</span><span class="p">:</span>
                <span class="c1">#print(d.node, d.exts)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">node_id</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
                <span class="n">edge_labels</span><span class="p">[(</span><span class="n">d</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">task</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">exts</span><span class="p">)</span>

        <span class="c1"># This part is needed if we have a work that produces output used by other nodes.</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">children</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">work</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">work</span><span class="p">)</span>
                <span class="n">edge_labels</span><span class="p">[(</span><span class="n">task</span><span class="p">,</span> <span class="n">work</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;all_ok &quot;</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="c1">#print(child)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                <span class="n">edge_labels</span><span class="p">[(</span><span class="n">work</span><span class="p">,</span> <span class="n">child</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">deps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">exts</span><span class="p">)</span>

        <span class="c1"># Get positions for all nodes using layout_type.</span>
        <span class="c1"># e.g. pos = nx.spring_layout(g)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">layout_type</span> <span class="o">+</span> <span class="s2">&quot;_layout&quot;</span><span class="p">)(</span><span class="n">g</span><span class="p">)</span>

        <span class="c1"># Select function used to compute the size of the node</span>
        <span class="k">def</span> <span class="nf">make_node_size</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_task</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">300</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">num_cores</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">600</span>

        <span class="c1"># Function used to build the label</span>
        <span class="k">def</span> <span class="nf">make_node_label</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node_label</span> <span class="o">==</span> <span class="s2">&quot;name_class&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_file</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">pos_str</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;pos_str&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;node_label: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_label</span><span class="p">))</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">make_node_label</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()}</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># Select plot type.</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;network&quot;</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                             <span class="n">node_color</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">color_rgb</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()],</span>
                             <span class="n">node_size</span><span class="o">=</span><span class="p">[</span><span class="n">make_node_size</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">()],</span>
                             <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">arrows</span><span class="o">=</span><span class="n">arrows</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

            <span class="c1"># Draw edge labels</span>
            <span class="k">if</span> <span class="n">with_edge_labels</span><span class="p">:</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edge_labels</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">edge_labels</span><span class="o">=</span><span class="n">edge_labels</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span>
            <span class="c1"># Group tasks by status (only tasks are show here).</span>
            <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_STATUS</span><span class="p">:</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iflat_tasks</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>

                <span class="c1"># Draw nodes (color is given by status)</span>
                <span class="n">node_color</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">color_opts</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">node_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">node_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
                <span class="c1">#print(&quot;num nodes %s with node_color %s&quot; % (len(tasks), node_color))</span>

                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
                                       <span class="n">nodelist</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
                                       <span class="n">node_color</span><span class="o">=</span><span class="n">node_color</span><span class="p">,</span>
                                       <span class="n">node_size</span><span class="o">=</span><span class="p">[</span><span class="n">make_node_size</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">],</span>
                                       <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
                                       <span class="c1">#label=str(status),</span>
                                       <span class="p">)</span>
            <span class="c1"># Draw edges.</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">arrows</span><span class="o">=</span><span class="n">arrows</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># edge_color=&#39;r&#39;)</span>

            <span class="c1"># Draw labels</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

            <span class="c1"># Draw edge labels</span>
            <span class="k">if</span> <span class="n">with_edge_labels</span><span class="p">:</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edge_labels</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">edge_labels</span><span class="o">=</span><span class="n">edge_labels</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="c1">#label_pos=0.5, font_size=10, font_color=&#39;k&#39;, font_family=&#39;sans-serif&#39;, font_weight=&#39;normal&#39;,</span>
                <span class="c1"># alpha=1.0, bbox=None, ax=None, rotate=True, **kwds)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown value for mode: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="G0W0WithQptdmFlow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.G0W0WithQptdmFlow">[docs]</a><span class="k">class</span> <span class="nc">G0W0WithQptdmFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a :class:`Flow` for one-shot G0W0 calculations.</span>
<span class="sd">        The computation of the q-points for the screening is parallelized with qptdm</span>
<span class="sd">        i.e. we run independent calculations for each q-point and then we merge the final results.</span>

<span class="sd">        Args:</span>
<span class="sd">            workdir: Working directory.</span>
<span class="sd">            scf_input: Input for the GS SCF run.</span>
<span class="sd">            nscf_input: Input for the NSCF run (band structure run).</span>
<span class="sd">            scr_input: Input for the SCR run.</span>
<span class="sd">            sigma_inputs: Input(s) for the SIGMA run(s).</span>
<span class="sd">            manager: :class:`TaskManager` object used to submit the jobs</span>
<span class="sd">                     Initialized from manager.yml if manager is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">G0W0WithQptdmFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c1"># Register the first work (GS + NSCF calculation)</span>
        <span class="n">bands_work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">BandStructureWork</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">))</span>

        <span class="c1"># Register the callback that will be executed the work for the SCR with qptdm.</span>
        <span class="n">scr_work</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_work_from_cbk</span><span class="p">(</span><span class="n">cbk_name</span><span class="o">=</span><span class="s2">&quot;cbk_qptdm_workflow&quot;</span><span class="p">,</span> <span class="n">cbk_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">scr_input</span><span class="p">},</span>
                                               <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">bands_work</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">work_class</span><span class="o">=</span><span class="n">QptdmWork</span><span class="p">)</span>

        <span class="c1"># The last work contains a list of SIGMA tasks</span>
        <span class="c1"># that will use the data produced in the previous two works.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">sigma_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigma_inputs</span><span class="p">]</span>

        <span class="n">sigma_work</span> <span class="o">=</span> <span class="n">Work</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sigma_input</span> <span class="ow">in</span> <span class="n">sigma_inputs</span><span class="p">:</span>
            <span class="n">sigma_work</span><span class="o">.</span><span class="n">register_sigma_task</span><span class="p">(</span><span class="n">sigma_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">bands_work</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">scr_work</span><span class="p">:</span> <span class="s2">&quot;SCR&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">sigma_work</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

<div class="viewcode-block" id="G0W0WithQptdmFlow.cbk_qptdm_workflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.G0W0WithQptdmFlow.cbk_qptdm_workflow">[docs]</a>    <span class="k">def</span> <span class="nf">cbk_qptdm_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This callback is executed by the flow when bands_work.nscf_task reaches S_OK.</span>

<span class="sd">        It computes the list of q-points for the W(q,G,G&#39;), creates nqpt tasks</span>
<span class="sd">        in the second work (QptdmWork), and connect the signals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scr_input</span> <span class="o">=</span> <span class="n">cbk</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="c1"># Use the WFK file produced by the second</span>
        <span class="c1"># Task in the first Work (NSCF step).</span>
        <span class="n">nscf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">wfk_file</span> <span class="o">=</span> <span class="n">nscf_task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">)</span>

        <span class="n">work</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">work</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">work</span><span class="o">.</span><span class="n">create_tasks</span><span class="p">(</span><span class="n">wfk_file</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">)</span>
        <span class="n">work</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">cbk</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>

        <span class="n">work</span><span class="o">.</span><span class="n">set_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Each task has a reference to its work.</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">work</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
            <span class="c1"># Add the garbage collector.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">set_gc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc</span><span class="p">)</span>

        <span class="n">work</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>
        <span class="n">work</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">work</span></div></div>


<span class="k">class</span> <span class="nc">FlowCallbackError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exceptions raised by FlowCallback.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">FlowCallback</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object implements the callbacks executed by the :class:`flow` when</span>
<span class="sd">    particular conditions are fulfilled. See on_dep_ok method of :class:`Flow`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        I decided to implement callbacks via this object instead of a standard</span>
<span class="sd">        approach based on bound methods because:</span>

<span class="sd">            1) pickle (v&lt;=3) does not support the pickling/unplickling of bound methods</span>

<span class="sd">            2) There&#39;s some extra logic and extra data needed for the proper functioning</span>
<span class="sd">               of a callback at the flow level and this object provides an easy-to-use interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">FlowCallbackError</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">cbk_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            func_name: String with the name of the callback to execute.</span>
<span class="sd">                       func_name must be a bound method of flow with signature:</span>

<span class="sd">                            func_name(self, cbk)</span>

<span class="sd">                       where self is the Flow instance and cbk is the callback</span>
<span class="sd">            flow: Reference to the :class:`Flow`</span>
<span class="sd">            deps: List of dependencies associated to the callback</span>
<span class="sd">                  The callback is executed when all dependencies reach S_OK.</span>
<span class="sd">            cbk_data: Dictionary with additional data that will be passed to the callback via self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">func_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">cbk_data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> bound to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the callback.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_execute</span><span class="p">():</span>
            <span class="c1"># Get the bound method of the flow from func_name.</span>
            <span class="c1"># We use this trick because pickle (format &lt;=3) does not support bound methods.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;You tried to __call_ a callback that cannot be executed!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if we can execute the callback.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">dep</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">S_OK</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the callback has been disabled. This usually happens when the callback has been executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable the callback&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">handle_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the callback is associated to the sender</span>
<span class="sd">        i.e. if the node who sent the signal appears in the</span>
<span class="sd">        dependencies of the callback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sender</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">node</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">]</span>


<span class="c1"># Factory functions.</span>
<div class="viewcode-block" id="bandstructure_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.bandstructure_flow">[docs]</a><span class="k">def</span> <span class="nf">bandstructure_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flow_class</span><span class="o">=</span><span class="n">Flow</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a :class:`Flow` for band structure calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir: Working directory.</span>
<span class="sd">        scf_input: Input for the GS SCF run.</span>
<span class="sd">        nscf_input: Input for the NSCF run (band structure run).</span>
<span class="sd">        dos_inputs: Input(s) for the NSCF run (dos run).</span>
<span class="sd">        manager: :class:`TaskManager` object used to submit the jobs</span>
<span class="sd">                 Initialized from manager.yml if manager is None.</span>
<span class="sd">        flow_class: Flow subclass</span>
<span class="sd">        allocate: True if the flow should be allocated before returning.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`Flow` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">flow_class</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">work</span> <span class="o">=</span> <span class="n">BandStructureWork</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="n">dos_inputs</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

    <span class="c1"># Handy aliases</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">,</span> <span class="n">flow</span><span class="o">.</span><span class="n">dos_tasks</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">,</span> <span class="n">work</span><span class="o">.</span><span class="n">dos_tasks</span>

    <span class="k">if</span> <span class="n">allocate</span><span class="p">:</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">flow</span></div>


<div class="viewcode-block" id="g0w0_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.g0w0_flow">[docs]</a><span class="k">def</span> <span class="nf">g0w0_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flow_class</span><span class="o">=</span><span class="n">Flow</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a :class:`Flow` for one-shot $G_0W_0$ calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir: Working directory.</span>
<span class="sd">        scf_input: Input for the GS SCF run.</span>
<span class="sd">        nscf_input: Input for the NSCF run (band structure run).</span>
<span class="sd">        scr_input: Input for the SCR run.</span>
<span class="sd">        sigma_inputs: List of inputs for the SIGMA run.</span>
<span class="sd">        flow_class: Flow class</span>
<span class="sd">        manager: :class:`TaskManager` object used to submit the jobs.</span>
<span class="sd">                 Initialized from manager.yml if manager is None.</span>
<span class="sd">        allocate: True if the flow should be allocated before returning.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`Flow` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">flow_class</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
    <span class="n">work</span> <span class="o">=</span> <span class="n">G0W0Work</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">)</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">allocate</span><span class="p">:</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">flow</span></div>


<span class="k">class</span> <span class="nc">PhononFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1) One workflow for the GS run.</span>

<span class="sd">        2) nqpt works for phonon calculations. Each work contains</span>
<span class="sd">           nirred tasks where nirred is the number of irreducible phonon perturbations</span>
<span class="sd">           for that particular q-point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_scf_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">with_becs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a `PhononFlow` for phonon calculations from an `AbinitInput` defining a ground-state run.</span>

<span class="sd">        Args:</span>
<span class="sd">            workdir: Working directory of the flow.</span>
<span class="sd">            scf_input: :class:`AbinitInput` object with the parameters for the GS-SCF run.</span>
<span class="sd">            ph_ngqpt: q-mesh for phonons. Must be a sub-mesh of the k-mesh used for</span>
<span class="sd">                electrons. e.g if ngkpt = (8, 8, 8). ph_ngqpt = (4, 4, 4) is a valid choice</span>
<span class="sd">                whereas ph_ngqpt = (3, 3, 3) is not!</span>
<span class="sd">            with_becs: True if Born effective charges are wanted.</span>
<span class="sd">            manager: :class:`TaskManager` object. Read from `manager.yml` if None.</span>
<span class="sd">            allocate: True if the flow should be allocated before returning.</span>

<span class="sd">        Return:</span>
<span class="sd">            :class:`PhononFlow` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c1"># Register the SCF task</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">register_scf_task</span><span class="p">(</span><span class="n">scf_input</span><span class="p">)</span>
        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Make sure k-mesh and q-mesh are compatible.</span>
        <span class="n">scf_ngkpt</span><span class="p">,</span> <span class="n">ph_ngqpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scf_input</span><span class="p">[</span><span class="s2">&quot;ngkpt&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ph_ngqpt</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">scf_ngkpt</span> <span class="o">%</span> <span class="n">ph_ngqpt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ph_ngqpt </span><span class="si">%s</span><span class="s2"> should be a sub-mesh of scf_ngkpt </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">scf_ngkpt</span><span class="p">))</span>

        <span class="c1"># Get the q-points in the IBZ from Abinit</span>
        <span class="n">qpoints</span> <span class="o">=</span> <span class="n">scf_input</span><span class="o">.</span><span class="n">abiget_ibz</span><span class="p">(</span><span class="n">ngkpt</span><span class="o">=</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">shiftk</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">kptopt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>

        <span class="c1"># Create a PhononWork for each q-point. Add DDK and E-field if q == Gamma and with_becs.</span>
        <span class="k">for</span> <span class="n">qpt</span> <span class="ow">in</span> <span class="n">qpoints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">qpt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">with_becs</span><span class="p">:</span>
                <span class="n">ph_work</span> <span class="o">=</span> <span class="n">BecWork</span><span class="o">.</span><span class="n">from_scf_task</span><span class="p">(</span><span class="n">scf_task</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ph_work</span> <span class="o">=</span> <span class="n">PhononWork</span><span class="o">.</span><span class="n">from_scf_task</span><span class="p">(</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">qpoints</span><span class="o">=</span><span class="n">qpt</span><span class="p">)</span>

            <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">ph_work</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">allocate</span><span class="p">:</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">flow</span>

    <span class="k">def</span> <span class="nf">open_final_ddb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the DDB file located in the output directory of the flow.</span>

<span class="sd">        Return:</span>
<span class="sd">            :class:`DdbFile` object, None if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;DDB&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ddb_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_OK</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> reached S_OK but didn&#39;t produce a GSR file in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="kn">from</span> <span class="nn">abipy.dfpt.ddb</span> <span class="k">import</span> <span class="n">DdbFile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DdbFile</span><span class="p">(</span><span class="n">ddb_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Exception while reading DDB file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ddb_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is called when the flow is completed.&quot;&quot;&quot;</span>
        <span class="c1"># Merge all the out_DDB files found in work.outdir.</span>
        <span class="n">ddb_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">work</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;DDB&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]))</span>

        <span class="c1"># Final DDB file will be produced in the outdir of the work.</span>
        <span class="n">out_ddb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s2">&quot;out_DDB&quot;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;DDB file merged by </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">())</span>

        <span class="n">mrgddb</span> <span class="o">=</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">Mrgddb</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mrgddb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">ddb_files</span><span class="p">,</span> <span class="n">out_ddb</span><span class="o">=</span><span class="n">out_ddb</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final DDB file available at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">out_ddb</span><span class="p">)</span>

        <span class="c1"># Call the method of the super class.</span>
        <span class="n">retcode</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PhononFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">retcode</span>


<span class="k">class</span> <span class="nc">NonLinearCoeffFlow</span><span class="p">(</span><span class="n">Flow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    1) One workflow for the GS run.</span>

<span class="sd">    2) nqpt works for electric field calculations. Each work contains</span>
<span class="sd">       nirred tasks where nirred is the number of irreducible perturbations</span>
<span class="sd">       for that particular q-point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_scf_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a `NonlinearFlow` for second order susceptibility calculations from</span>
<span class="sd">        an `AbinitInput` defining a ground-state run.</span>

<span class="sd">        Args:</span>
<span class="sd">            workdir: Working directory of the flow.</span>
<span class="sd">            scf_input: :class:`AbinitInput` object with the parameters for the GS-SCF run.</span>
<span class="sd">            manager: :class:`TaskManager` object. Read from `manager.yml` if None.</span>
<span class="sd">            allocate: True if the flow should be allocated before returning.</span>

<span class="sd">        Return:</span>
<span class="sd">            :class:`NonlinearFlow` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="n">flow</span><span class="o">.</span><span class="n">register_scf_task</span><span class="p">(</span><span class="n">scf_input</span><span class="p">)</span>
        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">nl_work</span> <span class="o">=</span> <span class="n">DteWork</span><span class="o">.</span><span class="n">from_scf_task</span><span class="p">(</span><span class="n">scf_task</span><span class="p">)</span>

        <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">nl_work</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">allocate</span><span class="p">:</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">flow</span>

    <span class="k">def</span> <span class="nf">open_final_ddb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the DDB file located in the output directory of the flow.</span>

<span class="sd">        Return:</span>
<span class="sd">            :class:`DdbFile` object, None if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;DDB&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ddb_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_OK</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> reached S_OK but didn&#39;t produce a GSR file in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="kn">from</span> <span class="nn">abipy.dfpt.ddb</span> <span class="k">import</span> <span class="n">DdbFile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DdbFile</span><span class="p">(</span><span class="n">ddb_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Exception while reading DDB file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ddb_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is called when the flow is completed.&quot;&quot;&quot;</span>
        <span class="c1"># Merge all the out_DDB files found in work.outdir.</span>
        <span class="n">ddb_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">work</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;DDB&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]))</span>

        <span class="c1"># Final DDB file will be produced in the outdir of the work.</span>
        <span class="n">out_ddb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s2">&quot;out_DDB&quot;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;DDB file merged by </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">())</span>

        <span class="n">mrgddb</span> <span class="o">=</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">Mrgddb</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mrgddb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">ddb_files</span><span class="p">,</span> <span class="n">out_ddb</span><span class="o">=</span><span class="n">out_ddb</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final DDB file available at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">out_ddb</span><span class="p">)</span>

        <span class="c1"># Call the method of the super class.</span>
        <span class="n">retcode</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">NonLinearCoeffFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;retcode&quot;</span><span class="p">,</span> <span class="n">retcode</span><span class="p">)</span>
        <span class="c1">#if retcode != 0: return retcode</span>
        <span class="k">return</span> <span class="n">retcode</span>


<div class="viewcode-block" id="phonon_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.flows.html#pymatgen.io.abinit.flows.phonon_flow">[docs]</a><span class="k">def</span> <span class="nf">phonon_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">ph_inputs</span><span class="p">,</span> <span class="n">with_nscf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_ddk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_dde</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flow_class</span><span class="o">=</span><span class="n">PhononFlow</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a :class:`PhononFlow` for phonon calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir: Working directory.</span>
<span class="sd">        scf_input: Input for the GS SCF run.</span>
<span class="sd">        ph_inputs: List of Inputs for the phonon runs.</span>
<span class="sd">        with_nscf: add an nscf task in front of al phonon tasks to make sure the q point is covered</span>
<span class="sd">        with_ddk: add the ddk step</span>
<span class="sd">        with_dde: add the dde step it the dde is set ddk is switched on automatically</span>
<span class="sd">        manager: :class:`TaskManager` used to submit the jobs</span>
<span class="sd">                 Initialized from manager.yml if manager is None.</span>
<span class="sd">        flow_class: Flow class</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`Flow` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;phonon_flow is deprecated and could give wrong results&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_dde</span><span class="p">:</span>
        <span class="n">with_ddk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scf_input</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

    <span class="c1"># Create the container that will manage the different works.</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">flow_class</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

    <span class="c1"># Register the first work (GS calculation)</span>
    <span class="c1"># register_task creates a work for the task, registers it to the flow and returns the work</span>
    <span class="c1"># the 0the element of the work is the task</span>
    <span class="n">scf_task</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Build a temporary work with a shell manager just to run</span>
    <span class="c1"># ABINIT to get the list of irreducible pertubations for this q-point.</span>
    <span class="n">shell_manager</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">to_shell_manager</span><span class="p">(</span><span class="n">mpi_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_ddk</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;add ddk&#39;</span><span class="p">)</span>
        <span class="c1"># TODO</span>
        <span class="c1"># MG Warning: be careful here because one should use tolde or tolwfr (tolvrs shall not be used!)</span>
        <span class="n">ddk_input</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">ddk_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">qpt</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">rfddk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rfelfd</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rfdir</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ddk_task</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">ddk_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s1">&#39;WFK&#39;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">DdkTask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">with_dde</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;add dde&#39;</span><span class="p">)</span>
        <span class="n">dde_input</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">dde_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">qpt</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">rfddk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rfelfd</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dde_input_idir</span> <span class="o">=</span> <span class="n">dde_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">dde_input_idir</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">rfdir</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">dde_task</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">dde_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s1">&#39;WFK&#39;</span><span class="p">,</span> <span class="n">ddk_task</span><span class="p">:</span> <span class="s1">&#39;DDK&#39;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">DdeTask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ph_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">ph_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ph_inputs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ph_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ph_inputs</span><span class="p">):</span>
        <span class="n">fake_input</span> <span class="o">=</span> <span class="n">ph_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

        <span class="c1"># Run abinit on the front-end to get the list of irreducible pertubations.</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;__ph_run&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">PhononWork</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">shell_manager</span><span class="p">)</span>
        <span class="n">fake_task</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fake_input</span><span class="p">)</span>

        <span class="c1"># Use the magic value paral_rf = -1 to get the list of irreducible perturbations for this q-point.</span>
        <span class="n">abivars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">paral_rf</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">rfatpol</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">natom</span><span class="p">],</span>  <span class="c1"># Set of atoms to displace.</span>
            <span class="n">rfdir</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>     <span class="c1"># Along this set of reduced coordinate axis.</span>
        <span class="p">)</span>

        <span class="n">fake_task</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">abivars</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Parse the file to get the perturbations.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">irred_perts</span> <span class="o">=</span> <span class="n">yaml_read_irred_perts</span><span class="p">(</span><span class="n">fake_task</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fake_task</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">irred_perts</span><span class="p">)</span>

        <span class="n">w</span><span class="o">.</span><span class="n">rmtree</span><span class="p">()</span>

        <span class="c1"># Now we can build the final list of works:</span>
        <span class="c1"># One work per q-point, each work computes all</span>
        <span class="c1"># the irreducible perturbations for a singe q-point.</span>

        <span class="n">work_qpt</span> <span class="o">=</span> <span class="n">PhononWork</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">with_nscf</span><span class="p">:</span>
            <span class="c1"># MG: Warning this code assume 0 is Gamma!</span>
            <span class="n">nscf_input</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scf_input</span><span class="p">)</span>
            <span class="n">nscf_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">kptopt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">iscf</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">qpt</span><span class="o">=</span><span class="n">irred_perts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">nqpt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nscf_task</span> <span class="o">=</span> <span class="n">work_qpt</span><span class="o">.</span><span class="n">register_nscf_task</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s2">&quot;DEN&quot;</span><span class="p">})</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s2">&quot;WFQ&quot;</span><span class="p">,</span> <span class="n">scf_task</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">scf_task</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">with_ddk</span><span class="p">:</span>
            <span class="n">deps</span><span class="p">[</span><span class="n">ddk_task</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DDK&#39;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">irred_perts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;qpt&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">irred_pert</span> <span class="ow">in</span> <span class="n">irred_perts</span><span class="p">:</span>
            <span class="c1">#print(irred_pert)</span>
            <span class="n">new_input</span> <span class="o">=</span> <span class="n">ph_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>

            <span class="c1">#rfatpol   1 1   # Only the first atom is displaced</span>
            <span class="c1">#rfdir   1 0 0   # Along the first reduced coordinate axis</span>
            <span class="n">qpt</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s2">&quot;qpt&quot;</span><span class="p">]</span>
            <span class="n">idir</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s2">&quot;idir&quot;</span><span class="p">]</span>
            <span class="n">ipert</span> <span class="o">=</span> <span class="n">irred_pert</span><span class="p">[</span><span class="s2">&quot;ipert&quot;</span><span class="p">]</span>

            <span class="c1"># TODO this will work for phonons, but not for the other types of perturbations.</span>
            <span class="n">rfdir</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rfdir</span><span class="p">[</span><span class="n">idir</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rfatpol</span> <span class="o">=</span> <span class="p">[</span><span class="n">ipert</span><span class="p">,</span> <span class="n">ipert</span><span class="p">]</span>

            <span class="n">new_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span>
                <span class="c1">#rfpert=1,</span>
                <span class="n">qpt</span><span class="o">=</span><span class="n">qpt</span><span class="p">,</span>
                <span class="n">rfdir</span><span class="o">=</span><span class="n">rfdir</span><span class="p">,</span>
                <span class="n">rfatpol</span><span class="o">=</span><span class="n">rfatpol</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">with_ddk</span><span class="p">:</span>
                <span class="n">new_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">rfelfd</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">work_qpt</span><span class="o">.</span><span class="n">register_phonon_task</span><span class="p">(</span><span class="n">new_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">)</span>

        <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">work_qpt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">allocate</span><span class="p">:</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">flow</span></div>


<span class="k">def</span> <span class="nf">phonon_conv_flow</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">qpoints</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allocate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a :class:`Flow` to perform convergence studies for phonon calculations.</span>

<span class="sd">    Args:</span>
<span class="sd">        workdir: Working directory of the flow.</span>
<span class="sd">        scf_input: :class:`AbinitInput` object defining a GS-SCF calculation.</span>
<span class="sd">        qpoints: List of list of lists with the reduced coordinates of the q-point(s).</span>
<span class="sd">        params:</span>
<span class="sd">            To perform a converge study wrt ecut: params=[&quot;ecut&quot;, [2, 4, 6]]</span>
<span class="sd">        manager: :class:`TaskManager` object responsible for the submission of the jobs.</span>
<span class="sd">            If manager is None, the object is initialized from the yaml file</span>
<span class="sd">            located either in the working directory or in the user configuration dir.</span>
<span class="sd">        allocate: True if the flow should be allocated before returning.</span>

<span class="sd">    Return:</span>
<span class="sd">        :class:`Flow` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">qpoints</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">qpt</span> <span class="ow">in</span> <span class="n">qpoints</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">gs_inp</span> <span class="ow">in</span> <span class="n">scf_input</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">):</span>
            <span class="c1"># Register the SCF task</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">register_scf_task</span><span class="p">(</span><span class="n">gs_inp</span><span class="p">)</span>

            <span class="c1"># Add the PhononWork connected to this scf_task.</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">register_work</span><span class="p">(</span><span class="n">PhononWork</span><span class="o">.</span><span class="n">from_scf_task</span><span class="p">(</span><span class="n">work</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qpoints</span><span class="o">=</span><span class="n">qpt</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">allocate</span><span class="p">:</span> <span class="n">flow</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">flow</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 2018.9.12 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../pymatgen.html" >pymatgen</a> &#187;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2011, Pymatgen Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.0.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>